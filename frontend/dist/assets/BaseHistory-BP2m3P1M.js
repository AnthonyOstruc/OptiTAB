import{A as we,a as u,c as _,e as ne,f as ke,b as o,o as l,d as n,i as g,t as y,k as w,m as O,M as J,F as B,s as M,n as re,B as oe}from"./vendor-1gmgAmFu.js";import{_ as Ae,u as Ce,t as K,b as H}from"./index-DCsGFNRY.js";import{b as Ie,a as Se,f as Pe}from"./curriculum-snq3CWRS.js";import{g as Ee}from"./matieres-D5ssBX4k.js";const $e={class:"base-history"},De={class:"history-header"},Ne={class:"history-title"},Te={class:"history-actions"},xe={class:"history-filters"},Re=["value"],Fe=["disabled"],Le=["value"],Be=["disabled"],Me=["value"],He={key:0,class:"stats-section"},Ue={key:1,class:"matiere-stats"},qe={key:2,class:"matiere-stats"},ze={key:3,class:"items-list-section"},Ve={class:"section-subtitle"},je={key:0,class:"inline-filters"},Ge={key:0,class:"items-list-content"},Oe={key:0,class:"empty-state"},Je={key:1,class:"items-grid"},Ke={key:2,class:"pagination-container"},We=["disabled"],Qe={class:"pagination-pages"},Xe=["onClick"],Ye=["disabled"],Ze={key:4,class:"loading-state"},et={__name:"BaseHistory",props:{title:{type:String,required:!0},listTitle:{type:String,required:!0},loadingText:{type:String,default:"Chargement..."},apiEndpoint:{type:String,required:!0},customFilters:{type:Array,default:()=>[]},extraParams:{type:Object,default:()=>({})},navigationHandler:{type:Function,default:null},itemsPerPage:{type:Number,default:12},filteredItems:{type:Array,default:null}},emits:["data-loaded","filter-changed"],setup(b,{expose:le,emit:ue}){const v=b,E=ue,k=Ce();we();const m=u(!0),U=u({}),q=u([]),$=u([]),D=u([]),z=u([]),A=u([]),C=u([]),I=u({}),V=u(!1),c=u(""),d=u(""),f=u(""),W=u("all"),p=u(1),N=u(new Set),T=u(!0),Q=_(()=>{if(!c.value)return[];const t=parseInt(c.value);return A.value.filter(a=>{const s=typeof a.theme=="object"?a.theme?.id:a.theme;let i=null;return typeof a.theme=="object"&&(i=a.theme?.matiere_id||a.theme?.matiere?.id||null),!i&&s&&I.value[s]&&(i=I.value[s].matiere_id||I.value[s].matiere),parseInt(i)===t})}),de=_(()=>{if(!d.value)return[];const t=parseInt(d.value);return C.value.filter(e=>{const a=e.notion_id??e.notion?.id??(typeof e.notion=="number"?e.notion:null);return parseInt(a)===t})}),x=_(()=>v.filteredItems?v.filteredItems:q.value),R=_(()=>Math.ceil(x.value.length/v.itemsPerPage)),ce=_(()=>{const t=(p.value-1)*v.itemsPerPage,e=t+v.itemsPerPage;return x.value.slice(t,e)}),ve=_(()=>{const t=[],e=R.value,a=p.value;if(X.value)return e<=1?[1]:[1,"...",e];if(e<=7)for(let s=1;s<=e;s++)t.push(s);else if(a<=4){for(let s=1;s<=5;s++)t.push(s);e>5&&t.push("..."),t.push(e)}else if(a>=e-3){t.push(1),e>6&&t.push("...");for(let s=e-4;s<=e;s++)s>1&&t.push(s)}else{t.push(1),t.push("...");for(let s=a-1;s<=a+1;s++)t.push(s);t.push("..."),t.push(e)}return t}),X=u(!1),j=()=>{typeof window<"u"&&(X.value=window.innerWidth<=768)};ne(()=>{j(),typeof window<"u"&&window.addEventListener("resize",j)}),ke(()=>{typeof window<"u"&&window.removeEventListener("resize",j)});const Y=_(()=>z.value||[]),me=async()=>{try{const[t,e]=await Promise.all([K.cachedGet("/api/matieres/user_matieres/",{ttl:864e5}),K.cachedGet("/api/themes/notions-pour-utilisateur/",{ttl:864e5}).catch(()=>H.get("/api/themes/notions-pour-utilisateur/"))]);let a=[];t?.data?.matieres_disponibles?a=t.data.matieres_disponibles:t?.data?.data?a=t.data.data:Array.isArray(t?.data)&&(a=t.data);let s=[];const i=e?.data?.themes||[],P=e?.data?.notions||[],L={};i.forEach(h=>{const ie=h.matiere_id||h.matiere&&(h.matiere.id||h.matiere);L[h.id]={matiere_id:ie,matiere:ie}}),I.value=L,Array.isArray(P)&&P.length>0&&(s=P);const r=[];z.value=Array.isArray(a)?a:[],A.value=Array.isArray(s)?s:[],C.value=Array.isArray(r)?r:[],await oe(),V.value=!0}catch{try{const[e,a]=await Promise.all([Ee({}),Pe({})]);z.value=Array.isArray(e?.data)?e.data:e?.results||[],A.value=Array.isArray(a?.data)?a.data:a?.results||[],C.value=[],await oe(),V.value=!0}catch{}}},S=async(t=!0)=>{t&&(m.value=!0);try{const e={...v.extraParams||{}};c.value&&(e.matiere=c.value),d.value&&(e.notion=d.value),f.value&&(e.chapitre=f.value);const s=(await K.cachedGet(v.apiEndpoint,{params:e,ttl:3e4})).data;U.value=s.global_stats||{},q.value=s.quiz_list||s.exercice_list||[],$.value=s.matiere_stats||[],D.value=s.matiere_notion_stats||[];try{const i=ee(e);localStorage.setItem(i,JSON.stringify({t:Date.now(),data:s}))}catch{}E("data-loaded",s)}catch{}finally{t&&(m.value=!1)}},Z=async()=>{V.value||await me()},ee=t=>{let e="anon";try{e=k?.id||"anon"}catch{}const a=Object.keys(t||{}).sort().map(s=>`${s}:${t[s]}`).join("|");return`BH_CACHE:${v.apiEndpoint}|${e}|${a}`},fe=async()=>{try{const t={...v.extraParams||{}},e=ee(t),a=localStorage.getItem(e);if(!a)return!1;const{t:s,data:i}=JSON.parse(a);return i?(U.value=i.global_stats||{},q.value=i.quiz_list||i.exercice_list||[],$.value=i.matiere_stats||[],D.value=i.matiere_notion_stats||[],m.value=!1,S(!1),!0):!1}catch{return!1}},pe=async()=>{if(d.value="",f.value="",F(),c.value&&Q.value.length===0)try{const t=await H.get("/api/themes/notions-pour-utilisateur/",{params:{matiere:c.value}}),e=t?.data?.themes||[],a=t?.data?.notions||[],s={};e.forEach(r=>{const h=r.matiere_id||r.matiere&&(r.matiere.id||r.matiere);s[r.id]={matiere_id:h,matiere:h}}),I.value={...I.value,...s};let i=a;if(!Array.isArray(i)||i.length===0){const r=await H.get("/api/notions/pour-utilisateur/",{params:{matiere:c.value}});r?.data?.notions_disponibles?i=r.data.notions_disponibles:r?.data?.data?i=r.data.data:Array.isArray(r?.data)?i=r.data:r?.data?.results&&(i=r.data.results)}const P=A.value.map(r=>r.id),L=i.filter(r=>!P.includes(r.id));A.value=[...A.value,...L]}catch{}S(),E("filter-changed",{matiere:c.value,notion:d.value,chapitre:f.value})},he=async()=>{if(f.value="",F(),d.value)try{let t=await Ie(d.value),e=[];if(Array.isArray(t?.data)?e=t.data:t?.data?.results&&(e=t.data.results),e.length===0){const a=await Se({notion:d.value});Array.isArray(a?.data)?e=a.data:a?.data?.results&&(e=a.data.results)}if(e.length===0){const a=await H.get(`/api/notions/${d.value}/chapitres/`);Array.isArray(a?.data)?e=a.data:a?.data?.results&&(e=a.data.results)}if(e.length>0){const a=C.value.map(i=>i.id),s=e.filter(i=>!a.includes(i.id));C.value=[...C.value,...s]}}catch{}S(),E("filter-changed",{matiere:c.value,notion:d.value,chapitre:f.value})},ge=()=>{F(),S(),E("filter-changed",{matiere:c.value,notion:d.value,chapitre:f.value})},te=t=>{N.value.has(t)?N.value.delete(t):N.value.add(t)},ae=t=>N.value.has(t),ye=()=>{T.value=!T.value},se=t=>{v.navigationHandler&&v.navigationHandler(t)},G=t=>{typeof t=="number"&&t>=1&&t<=R.value&&(p.value=t)},F=()=>{p.value=1},be=t=>new Date(t).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),_e=t=>{const e=Math.floor(t/60),a=t%60;return`${e}:${a.toString().padStart(2,"0")}`};return ne(async()=>{if(k.isLoading||!k.isAuthenticated&&!k.id){let e=0;for(;(k.isLoading||!k.isAuthenticated)&&e<30;)await new Promise(a=>setTimeout(a,100)),e++}const t=await fe();await S(!t)}),le({formatDate:be,formatTime:_e,toggleItemDetails:te,isItemExpanded:ae,navigateToItem:se,selectedCustomFilter:W,resetPagination:F}),(t,e)=>(l(),o("div",$e,[n("div",De,[n("h3",Ne,y(b.title),1),n("div",Te,[w(t.$slots,"header-actions",{},void 0,!0)]),n("div",xe,[O((l(),o("select",{"onUpdate:modelValue":e[0]||(e[0]=a=>c.value=a),onChange:pe,onFocus:Z,onClick:Z,class:"filter-select",key:"matieres-"+Y.value.length},[e[5]||(e[5]=n("option",{value:""},"Toutes les matières",-1)),(l(!0),o(B,null,M(Y.value,a=>(l(),o("option",{key:`matiere-${a.id}`,value:a.id},y(a.titre||a.nom),9,Re))),128))],32)),[[J,c.value]]),O(n("select",{"onUpdate:modelValue":e[1]||(e[1]=a=>d.value=a),onChange:he,class:"filter-select",disabled:!c.value},[e[6]||(e[6]=n("option",{value:""},"Toutes les notions",-1)),(l(!0),o(B,null,M(Q.value,a=>(l(),o("option",{key:a.id,value:a.id},y(a.titre),9,Le))),128))],40,Fe),[[J,d.value]]),O(n("select",{"onUpdate:modelValue":e[2]||(e[2]=a=>f.value=a),onChange:ge,class:"filter-select",disabled:!d.value},[e[7]||(e[7]=n("option",{value:""},"Tous les chapitres",-1)),(l(!0),o(B,null,M(de.value,a=>(l(),o("option",{key:a.id,value:a.id},y(a.titre),9,Me))),128))],40,Be),[[J,f.value]])])]),m.value?g("",!0):(l(),o("div",He,[w(t.$slots,"global-stats",{stats:U.value,loading:m.value},void 0,!0)])),!m.value&&$.value.length>0?(l(),o("div",Ue,[w(t.$slots,"matiere-stats",{stats:$.value},void 0,!0)])):g("",!0),!m.value&&D.value.length>0?(l(),o("div",qe,[w(t.$slots,"matiere-notion-stats",{stats:D.value},void 0,!0)])):g("",!0),m.value?g("",!0):(l(),o("div",ze,[n("div",{class:"items-list-header",onClick:ye},[n("h4",Ve,y(b.listTitle)+" ("+y(x.value.length)+")",1),b.customFilters&&b.customFilters.length>0?(l(),o("div",je,[w(t.$slots,"custom-filters",{filters:b.customFilters,selected:W.value},void 0,!0)])):g("",!0),n("button",{class:re(["section-toggle",{expanded:T.value}])},e[8]||(e[8]=[n("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[n("polyline",{points:"6,9 12,15 18,9"})],-1)]),2)]),T.value?(l(),o("div",Ge,[x.value.length===0?(l(),o("div",Oe,[w(t.$slots,"empty-state",{},()=>[e[9]||(e[9]=n("p",null,"Aucun élément trouvé avec ces filtres",-1))],!0)])):(l(),o("div",Je,[w(t.$slots,"items-list",{items:ce.value,toggleDetails:te,isExpanded:ae,navigateToItem:se},void 0,!0)])),R.value>1?(l(),o("div",Ke,[n("button",{onClick:e[3]||(e[3]=a=>G(p.value-1)),disabled:p.value<=1,class:"pagination-btn prev",title:"Précédent","aria-label":"Précédent"},e[10]||(e[10]=[n("span",{class:"pagination-icon"},"‹",-1),n("span",{class:"pagination-label"},"Précédent",-1)]),8,We),n("div",Qe,[(l(!0),o(B,null,M(ve.value,a=>(l(),o("button",{key:a,onClick:s=>G(a),class:re(["pagination-page",{active:a===p.value}])},y(a),11,Xe))),128))]),n("button",{onClick:e[4]||(e[4]=a=>G(p.value+1)),disabled:p.value>=R.value,class:"pagination-btn next",title:"Suivant","aria-label":"Suivant"},e[11]||(e[11]=[n("span",{class:"pagination-label"},"Suivant",-1),n("span",{class:"pagination-icon"},"›",-1)]),8,Ye)])):g("",!0)])):g("",!0)])),m.value?(l(),o("div",Ze,[e[12]||(e[12]=n("div",{class:"spinner"},null,-1)),n("p",null,y(b.loadingText),1)])):g("",!0)]))}},nt=Ae(et,[["__scopeId","data-v-1a187379"]]);export{nt as B};
