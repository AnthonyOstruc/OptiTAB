import{A as we,a as u,c as A,e as ie,f as Ae,b as o,o as l,d as i,i as g,t as y,k as _,m as j,M as O,F as L,s as M,n as ne,B as re}from"./vendor-1gmgAmFu.js";import{_ as _e,u as ke,b}from"./index-DdsjLnq7.js";import{f as oe,a as W,b as Ie}from"./curriculum-6-VMzQHc.js";import{g as Ce}from"./matieres-DVwPPJpo.js";const Pe={class:"base-history"},Se={class:"history-header"},Ee={class:"history-title"},De={class:"history-actions"},Re={class:"history-filters"},Te=["value"],$e=["disabled"],Ne=["value"],xe=["disabled"],Fe=["value"],Le={key:0,class:"stats-section"},Me={key:1,class:"matiere-stats"},Be={key:2,class:"matiere-stats"},He={key:3,class:"items-list-section"},Ue={class:"section-subtitle"},Ve={key:0,class:"inline-filters"},qe={key:0,class:"items-list-content"},ze={key:0,class:"empty-state"},je={key:1,class:"items-grid"},Oe={key:2,class:"pagination-container"},We=["disabled"],Ge={class:"pagination-pages"},Je=["onClick"],Ke=["disabled"],Qe={key:4,class:"loading-state"},Xe={__name:"BaseHistory",props:{title:{type:String,required:!0},listTitle:{type:String,required:!0},loadingText:{type:String,default:"Chargement..."},apiEndpoint:{type:String,required:!0},customFilters:{type:Array,default:()=>[]},extraParams:{type:Object,default:()=>({})},navigationHandler:{type:Function,default:null},itemsPerPage:{type:Number,default:12},filteredItems:{type:Array,default:null}},emits:["data-loaded","filter-changed"],setup(w,{expose:le,emit:ue}){const v=w,D=ue,P=ke();we();const h=u(!0),G=u({}),J=u([]),B=u([]),H=u([]),U=u([]),k=u([]),I=u([]),C=u({}),c=u(""),d=u(""),m=u(""),K=u("all"),p=u(1),R=u(new Set),T=u(!0),Q=A(()=>{if(!c.value)return[];const t=parseInt(c.value);return k.value.filter(e=>{const s=typeof e.theme=="object"?e.theme?.id:e.theme;let n=null;return typeof e.theme=="object"&&(n=e.theme?.matiere_id||e.theme?.matiere?.id||null),!n&&s&&C.value[s]&&(n=C.value[s].matiere_id||C.value[s].matiere),parseInt(n)===t})}),de=A(()=>{if(!d.value)return[];const t=parseInt(d.value);return I.value.filter(a=>{const e=a.notion_id??a.notion?.id??(typeof a.notion=="number"?a.notion:null);return parseInt(e)===t})}),$=A(()=>v.filteredItems?v.filteredItems:J.value),N=A(()=>Math.ceil($.value.length/v.itemsPerPage)),ce=A(()=>{const t=(p.value-1)*v.itemsPerPage,a=t+v.itemsPerPage;return $.value.slice(t,a)}),ve=A(()=>{const t=[],a=N.value,e=p.value;if(X.value)return a<=1?[1]:[1,"...",a];if(a<=7)for(let s=1;s<=a;s++)t.push(s);else if(e<=4){for(let s=1;s<=5;s++)t.push(s);a>5&&t.push("..."),t.push(a)}else if(e>=a-3){t.push(1),a>6&&t.push("...");for(let s=a-4;s<=a;s++)s>1&&t.push(s)}else{t.push(1),t.push("...");for(let s=e-1;s<=e+1;s++)t.push(s);t.push("..."),t.push(a)}return t}),X=u(!1),V=()=>{typeof window<"u"&&(X.value=window.innerWidth<=768)};ie(()=>{V(),typeof window<"u"&&window.addEventListener("resize",V)}),Ae(()=>{typeof window<"u"&&window.removeEventListener("resize",V)});const Y=A(()=>U.value||[]),me=async()=>{try{const[t,a,e,s]=await Promise.all([b.get("/api/matieres/user_matieres/"),b.get("/api/themes/notions-pour-utilisateur/",{timeout:2e4}).catch(()=>b.get("/api/themes/notions-pour-utilisateur/")),oe({}).catch(()=>b.get("/api/notions/pour-utilisateur/",{timeout:2e4})),W({})]);let n=[];t?.data?.matieres_disponibles?n=t.data.matieres_disponibles:t?.data?.data?n=t.data.data:Array.isArray(t?.data)&&(n=t.data);let f=[];e?.data?.notions_disponibles?f=e.data.notions_disponibles:e?.data?.data?f=e.data.data:Array.isArray(e?.data)?f=e.data:e?.data?.results&&(f=e.data.results);const z=a?.data?.themes||[],r=a?.data?.notions||[],S={};z.forEach(E=>{const se=E.matiere_id||E.matiere&&(E.matiere.id||E.matiere);S[E.id]={matiere_id:se,matiere:se}}),C.value=S,Array.isArray(r)&&r.length>0&&(f=r);const ae=Array.isArray(s?.data)?s.data:s?.results||[];U.value=Array.isArray(n)?n:[],k.value=Array.isArray(f)?f:[],I.value=Array.isArray(ae)?ae:[],await re()}catch{try{const[a,e,s]=await Promise.all([Ce({}),oe({}),W({})]);U.value=Array.isArray(a?.data)?a.data:a?.results||[],k.value=Array.isArray(e?.data)?e.data:e?.results||[],I.value=Array.isArray(s?.data)?s.data:s?.results||[],await re()}catch{}}},x=async()=>{h.value=!0;try{const t={...v.extraParams||{}};c.value&&(t.matiere=c.value),d.value&&(t.notion=d.value),m.value&&(t.chapitre=m.value);const e=(await b.get(v.apiEndpoint,{params:t})).data;G.value=e.global_stats||{},J.value=e.quiz_list||e.exercice_list||[],B.value=e.matiere_stats||[],H.value=e.matiere_notion_stats||[],D("data-loaded",e)}catch{}finally{h.value=!1}},pe=async()=>{if(d.value="",m.value="",F(),c.value&&Q.value.length===0)try{const t=await b.get("/api/themes/notions-pour-utilisateur/",{params:{matiere:c.value}}),a=t?.data?.themes||[],e=t?.data?.notions||[],s={};a.forEach(r=>{const S=r.matiere_id||r.matiere&&(r.matiere.id||r.matiere);s[r.id]={matiere_id:S,matiere:S}}),C.value={...C.value,...s};let n=e;if(!Array.isArray(n)||n.length===0){const r=await b.get("/api/notions/pour-utilisateur/",{params:{matiere:c.value}});r?.data?.notions_disponibles?n=r.data.notions_disponibles:r?.data?.data?n=r.data.data:Array.isArray(r?.data)?n=r.data:r?.data?.results&&(n=r.data.results)}const f=k.value.map(r=>r.id),z=n.filter(r=>!f.includes(r.id));k.value=[...k.value,...z]}catch{}x(),D("filter-changed",{matiere:c.value,notion:d.value,chapitre:m.value})},fe=async()=>{if(m.value="",F(),d.value)try{let t=await Ie(d.value),a=[];if(Array.isArray(t?.data)?a=t.data:t?.data?.results&&(a=t.data.results),a.length===0){const e=await W({notion:d.value});Array.isArray(e?.data)?a=e.data:e?.data?.results&&(a=e.data.results)}if(a.length===0){const e=await b.get(`/api/notions/${d.value}/chapitres/`);Array.isArray(e?.data)?a=e.data:e?.data?.results&&(a=e.data.results)}if(a.length>0){const e=I.value.map(n=>n.id),s=a.filter(n=>!e.includes(n.id));I.value=[...I.value,...s]}}catch{}x(),D("filter-changed",{matiere:c.value,notion:d.value,chapitre:m.value})},he=()=>{F(),x(),D("filter-changed",{matiere:c.value,notion:d.value,chapitre:m.value})},Z=t=>{R.value.has(t)?R.value.delete(t):R.value.add(t)},ee=t=>R.value.has(t),ge=()=>{T.value=!T.value},te=t=>{v.navigationHandler&&v.navigationHandler(t)},q=t=>{typeof t=="number"&&t>=1&&t<=N.value&&(p.value=t)},F=()=>{p.value=1},ye=t=>new Date(t).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),be=t=>{const a=Math.floor(t/60),e=t%60;return`${a}:${e.toString().padStart(2,"0")}`};return ie(async()=>{if(P.isLoading||!P.isAuthenticated&&!P.id){let t=0;for(;(P.isLoading||!P.isAuthenticated)&&t<30;)await new Promise(a=>setTimeout(a,100)),t++}await me(),await x()}),le({formatDate:ye,formatTime:be,toggleItemDetails:Z,isItemExpanded:ee,navigateToItem:te,selectedCustomFilter:K,resetPagination:F}),(t,a)=>(l(),o("div",Pe,[i("div",Se,[i("h3",Ee,y(w.title),1),i("div",De,[_(t.$slots,"header-actions",{},void 0,!0)]),i("div",Re,[j((l(),o("select",{"onUpdate:modelValue":a[0]||(a[0]=e=>c.value=e),onChange:pe,class:"filter-select",key:"matieres-"+Y.value.length},[a[5]||(a[5]=i("option",{value:""},"Toutes les matières",-1)),(l(!0),o(L,null,M(Y.value,e=>(l(),o("option",{key:`matiere-${e.id}`,value:e.id},y(e.titre||e.nom),9,Te))),128))],32)),[[O,c.value]]),j(i("select",{"onUpdate:modelValue":a[1]||(a[1]=e=>d.value=e),onChange:fe,class:"filter-select",disabled:!c.value},[a[6]||(a[6]=i("option",{value:""},"Toutes les notions",-1)),(l(!0),o(L,null,M(Q.value,e=>(l(),o("option",{key:e.id,value:e.id},y(e.titre),9,Ne))),128))],40,$e),[[O,d.value]]),j(i("select",{"onUpdate:modelValue":a[2]||(a[2]=e=>m.value=e),onChange:he,class:"filter-select",disabled:!d.value},[a[7]||(a[7]=i("option",{value:""},"Tous les chapitres",-1)),(l(!0),o(L,null,M(de.value,e=>(l(),o("option",{key:e.id,value:e.id},y(e.titre),9,Fe))),128))],40,xe),[[O,m.value]])])]),h.value?g("",!0):(l(),o("div",Le,[_(t.$slots,"global-stats",{stats:G.value,loading:h.value},void 0,!0)])),!h.value&&B.value.length>0?(l(),o("div",Me,[_(t.$slots,"matiere-stats",{stats:B.value},void 0,!0)])):g("",!0),!h.value&&H.value.length>0?(l(),o("div",Be,[_(t.$slots,"matiere-notion-stats",{stats:H.value},void 0,!0)])):g("",!0),h.value?g("",!0):(l(),o("div",He,[i("div",{class:"items-list-header",onClick:ge},[i("h4",Ue,y(w.listTitle)+" ("+y($.value.length)+")",1),w.customFilters&&w.customFilters.length>0?(l(),o("div",Ve,[_(t.$slots,"custom-filters",{filters:w.customFilters,selected:K.value},void 0,!0)])):g("",!0),i("button",{class:ne(["section-toggle",{expanded:T.value}])},a[8]||(a[8]=[i("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[i("polyline",{points:"6,9 12,15 18,9"})],-1)]),2)]),T.value?(l(),o("div",qe,[$.value.length===0?(l(),o("div",ze,[_(t.$slots,"empty-state",{},()=>[a[9]||(a[9]=i("p",null,"Aucun élément trouvé avec ces filtres",-1))],!0)])):(l(),o("div",je,[_(t.$slots,"items-list",{items:ce.value,toggleDetails:Z,isExpanded:ee,navigateToItem:te},void 0,!0)])),N.value>1?(l(),o("div",Oe,[i("button",{onClick:a[3]||(a[3]=e=>q(p.value-1)),disabled:p.value<=1,class:"pagination-btn prev",title:"Précédent","aria-label":"Précédent"},a[10]||(a[10]=[i("span",{class:"pagination-icon"},"‹",-1),i("span",{class:"pagination-label"},"Précédent",-1)]),8,We),i("div",Ge,[(l(!0),o(L,null,M(ve.value,e=>(l(),o("button",{key:e,onClick:s=>q(e),class:ne(["pagination-page",{active:e===p.value}])},y(e),11,Je))),128))]),i("button",{onClick:a[4]||(a[4]=e=>q(p.value+1)),disabled:p.value>=N.value,class:"pagination-btn next",title:"Suivant","aria-label":"Suivant"},a[11]||(a[11]=[i("span",{class:"pagination-label"},"Suivant",-1),i("span",{class:"pagination-icon"},"›",-1)]),8,Ke)])):g("",!0)])):g("",!0)])),h.value?(l(),o("div",Qe,[a[12]||(a[12]=i("div",{class:"spinner"},null,-1)),i("p",null,y(w.loadingText),1)])):g("",!0)]))}},at=_e(Xe,[["__scopeId","data-v-4e7ed385"]]);export{at as B};
