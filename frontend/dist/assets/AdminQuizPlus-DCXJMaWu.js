import{_ as ne,h as _,p as oe,m as re,s as R,c,a2 as le,a,b as f,k as j,z as ue,F as z,e as k,t as d,d as q,v as ce,B as T,o as m,j as V}from"./index-C20tTf3S.js";import{a as me,g as de}from"./curriculum-C6dJwtfd.js";import{e as pe,h as ge,u as ve}from"./quiz-BenXfgLR.js";const he={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_API_URL:"https://optitab-backend.onrender.com",VITE_GOOGLE_CLIENT_ID:"demo-client-id.apps.googleusercontent.com"},fe={class:"bulk-form"},_e={class:"form-row"},xe=["value"],ye={class:"stats"},Ie={key:0,class:"stat-item"},be={key:0,class:"context-panel"},$e={class:"context-row"},qe={class:"context-row"},we={class:"context-row"},Ee={class:"context-row"},Ne={class:"images-upload-section"},ze={key:0,class:"selected-images"},ke=["src","alt"],Ce={class:"image-name"},Qe=["onClick"],Me={class:"btn-group"},Ae=["disabled"],Te=["disabled"],Le={key:0,class:"success-msg"},We={key:1,class:"error-msg"},Se={key:2,class:"preview-section"},Ue={class:"preview-header"},Be={class:"preview-title"},Pe={class:"quiz-grid"},Re={class:"quiz-header"},je={class:"quiz-title"},Ve={class:"quiz-instructions"},Fe={class:"questions-summary"},Oe={class:"questions-count"},De={key:0,class:"explanations-count"},Ge={key:1,class:"images-count"},Je={class:"questions-preview"},He={class:"question-header"},Xe=["innerHTML"],Ye={class:"options-mini"},Ze=["innerHTML"],Ke={key:0,class:"explanation-section"},et={key:0,class:"explanation-mini"},tt=["innerHTML"],st={key:1,class:"no-explanation"},it={key:0,class:"more-questions"},at={key:0},nt=10*1024*1024,ot={__name:"AdminQuizPlus",setup(rt){const C=_([]),L=_([]),I=_(""),y=_(""),b=_(""),h=_(""),v=_([]),$=_(!0),w=_([]),Q=_(null),F=["image/jpeg","image/jpg","image/png","image/gif","image/webp"];class O{constructor(){this.images=new Map,this.imageTypes=new Map}addImage(e){if(!this.validateImage(e))throw new Error(`Image invalide: ${e.name}`);this.images.set(e.name,e)}removeImage(e){this.images.delete(e),this.imageTypes.delete(e)}validateImage(e){return!(!F.includes(e.type)||e.size>nt)}getImage(e){let t=this.images.get(e);if(t)return t;for(const[i,n]of this.images)if(i.toLowerCase()===e.toLowerCase())return n;return null}parseImageString(e){return e?e.split(",").map(t=>t.trim()).filter(Boolean):[]}validateImageReferences(e){const t=this.parseImageString(e),i=[];for(const n of t)this.getImage(n)||i.push(n);return{valid:i.length===0,missing:i}}determineImageType(e,t){return"question"}}class D{constructor(e){this.imageManager=e}async createQuizWithImages(e){try{const t=await pe({chapitre:Number(e.chapitre),titre:e.titre,contenu:e.instruction||e.titre||"Quiz",difficulty:e.difficulty||"medium",questions_data:Array.isArray(e.questions)?e.questions:[]}),i=t&&t.data&&t.data.id?t.data.id:t&&t.id?t.id:null;return e.image&&await this.addImagesToQuiz(i,e),{success:!0,quizId:i}}catch(t){return console.error("Erreur lors de la création du quiz:",t,t?.response?.data),{success:!1,error:t.response?.data?JSON.stringify(t.response.data):t.message||"Erreur inconnue"}}}async addImagesToQuiz(e,t){const i=this.imageManager.parseImageString(t.image),n=[],o=new Map;for(let r=0;r<i.length;r++){const p=i[r],l=this.imageManager.getImage(p);if(l)try{const N=this.imageManager.determineImageType(t,r+1),u=await ge({quiz:e,image:l,image_type:N,position:r+1});if(u?.data?.image){let g=u.data.image;if(!/^https?:\/\//i.test(g)){const P=he?.VITE_API_BASE_URL||"http://127.0.0.1:8000";g.startsWith("/")?g=P+g:g=P+"/media/"+g}o.set(r+1,g)}}catch(N){console.error(`Erreur lors de l'ajout de l'image ${p}:`,N),n.push(`Image ${p} non ajoutée`)}else n.push(`Image ${p} non trouvée`)}if(o.size>0)try{await this.updateQuizQuestionsWithImageUrls(e,t,o)}catch(r){console.error("Erreur lors de la mise à jour des questions avec les URLs d'images:",r),n.push("Erreur lors de la mise à jour des URLs d'images dans les questions")}return n}async updateQuizQuestionsWithImageUrls(e,t,i){const n=t.questions.map(o=>{const r={...o};return r.question&&(r.question=this.replaceImageMarkersWithUrls(r.question,i)),r.options&&(r.options=r.options.map(p=>this.replaceImageMarkersWithUrls(p,i))),r.explanation&&(r.explanation=this.replaceImageMarkersWithUrls(r.explanation,i)),r});await ve(e,{questions_data:n})}replaceImageMarkersWithUrls(e,t){return e&&e.replace(/\[IMAGE_(\d+)\]/g,(i,n)=>{const o=parseInt(n),r=t.get(o);return r?`<img src="${r}" alt="Image ${o}" style="max-width: 300px; height: auto; border-radius: 6px; margin: 8px 0; border: 1px solid #e5e7eb;" />`:i})}}const x=new O,G=new D(x);async function J(){try{const[s,e]=await Promise.all([me(),de()]);C.value=Array.isArray(s)?s:s?.data||[],L.value=Array.isArray(e)?e:e?.data||[]}catch(s){console.error("Erreur chargement:",s)}}oe(J);function W(s){return L.value.find(e=>String(e.id)===String(s))}function S(s){if(!s)return null;const e=W(s.notion);if(!e)return{themeNom:"",matiereNom:"",paysNom:"",niveauNom:""};const t=e.matiere_nom||e.contexte_detail&&e.contexte_detail.matiere_nom||"",i=e.theme_nom||"",n=e.contexte_detail&&e.contexte_detail.pays?e.contexte_detail.pays.nom:"",o=e.contexte_detail&&e.contexte_detail.niveau?e.contexte_detail.niveau.nom:"";return{matiereNom:t,themeNom:i,paysNom:n,niveauNom:o}}const E=re(()=>{const s=C.value.find(e=>String(e.id)===String(I.value));return s?S(s):null});function H(s){const e=W(s.notion),t=S(s);return[s.nom,e?`— ${e.nom}`:"",t&&t.matiereNom?`— ${t.matiereNom}`:"",t&&(t.paysNom||t.niveauNom)?`— ${[t.paysNom,t.niveauNom].filter(Boolean).join(" · ")}`:""].filter(Boolean).join(" ")}function X(s){return{easy:"⭐ Facile",medium:"⭐⭐ Moyen",hard:"⭐⭐⭐ Difficile"}[s]||s}function U(){return v.value.reduce((s,e)=>s+e.questions.length,0)}const M=()=>{T(()=>{window.MathJax&&window.MathJax.typesetPromise()})};R(v,()=>{v.value.length>0&&M()},{deep:!0}),R($,()=>{v.value.length>0&&T(()=>{setTimeout(()=>M(),100)})});function B(){const s=y.value.trim();return s?s.includes("===")?Y(s):Z(s):[]}function Y(s){return s.split(/^={3,}\s*$/m).map(t=>t.trim()).filter(Boolean).map(t=>{let i="",n="",o="medium",r="";const p=[];let l=null;const N=t.split(`
`).map(u=>u.trim());for(const u of N)if(u.startsWith("Titre:"))i=u.slice(6).trim();else if(u.startsWith("Instructions:"))n=u.slice(12).trim();else if(u.startsWith("Difficulté:")||u.startsWith("Difficulty:"))o=u.split(":")[1].trim().toLowerCase();else if(u.startsWith("Images:"))r=u.slice(7).trim();else if(u.startsWith("Question:"))l&&l.question&&p.push({...l}),l={question:u.slice(9).trim(),options:[],correct_answer:0,explanation:""};else if(u.match(/^[A-F]:/))l&&l.options.push(u.slice(2).trim());else if(u.startsWith("Correct:")){if(l){const g=u.slice(8).trim().toUpperCase();l.correct_answer=g.charCodeAt(0)-65}}else if(u.startsWith("Explication:")){if(l){let g=u.slice(12).trim();g=g.replace(/\\/g,"\\"),l.explanation=g}}else if(l&&l.explanation&&u.trim()){let g=u.trim();g=g.replace(/\\/g,"\\"),l.explanation+=" "+g}else if(l&&u.trim()){const g=u.trim();l.question=l.question?l.question+`
`+g:g}return l&&l.question&&p.push({...l}),{titre:i||"Quiz sans titre",instruction:n||"Quiz",difficulty:o,image:r,questions:p,chapitre:Number(I.value)}})}function Z(s){return s.split(`
`).map(t=>t.trim()).filter(Boolean).map(t=>{const i=t.split(";;").map(o=>o.trim());let n=[];try{n=i[3]?JSON.parse(i[3]):[]}catch{console.warn("JSON invalide pour les questions:",i[3])}return{titre:i[0]||"Quiz sans titre",instruction:i[1]||"Quiz",difficulty:(i[2]||"medium").toLowerCase(),questions:n,chapitre:Number(I.value)}})}async function K(){h.value="",b.value="";try{const s=B().filter(o=>o.titre&&o.questions.length>0);if(s.length===0){h.value="Aucun quiz valide trouvé. Vérifiez le format.";return}let e=0,t=0,i=[];for(const o of s){if(o.image){const p=x.validateImageReferences(o.image);if(!p.valid){i.push(`Images manquantes pour "${o.titre}": ${p.missing.join(", ")}`);continue}}const r=await G.createQuizWithImages(o);r.success?(e++,t+=Array.isArray(o.questions)?o.questions.length:0):i.push(`Erreur pour "${o.titre}": ${r.error}`)}let n=`${e} quiz créés avec ${t} questions au total !`;i.length>0&&(n+=`

Erreurs : ${i.join(" | ")}`,h.value=`Certains quiz n'ont pas pu être créés : ${i.join(" | ")}`),b.value=n,y.value="",v.value=[]}catch(s){console.error("Erreur création:",s);const e=s?.response?.data;if(e)try{h.value=typeof e=="string"?e:JSON.stringify(e)}catch{h.value="Erreur lors de la création des quiz."}else h.value="Erreur lors de la création des quiz."}}function ee(){h.value="",b.value="";try{const s=B().filter(e=>e.titre&&e.questions.length>0);v.value=s,console.log("Quiz parsés:",s.map(e=>({titre:e.titre,questions:e.questions.map(t=>({question:t.question.substring(0,50)+"...",hasExplanation:!!t.explanation,explanation:t.explanation,explanationLength:t.explanation?t.explanation.length:0}))}))),s.forEach(e=>{e.questions.forEach((t,i)=>{t.explanation&&console.log(`Explication Q${i+1}:`,t.explanation)})}),s.length===0?h.value="Aucun quiz valide trouvé. Vérifiez le format.":T(()=>M())}catch{h.value="Erreur lors du parsing. Vérifiez le format."}}function te(){y.value="",v.value=[],b.value="",h.value=""}function se(s){Array.from(s.target.files).forEach(t=>{try{x.addImage(t)}catch(i){h.value=i.message}}),w.value=Array.from(x.images.values())}function ie(s){const e=w.value[s];x.removeImage(e.name),w.value.splice(s,1),Q.value&&(Q.value.value="")}function ae(s){return URL.createObjectURL(s)}function A(s,e){if(!s||!e)return s;const t=x.parseImageString(e);return console.log("renderWithImages - text:",s),console.log("renderWithImages - imageString:",e),console.log("renderWithImages - imageNames:",t),console.log("renderWithImages - available images:",Array.from(x.images.keys())),s.replace(/\[IMAGE_(\d+)\]/g,(i,n)=>{const o=parseInt(n)-1;if(console.log(`renderWithImages - processing ${i}: imageNumber=${n}, imageIndex=${o}`),o>=0&&o<t.length){const r=t[o];console.log(`renderWithImages - imageName: ${r}`);const p=x.getImage(r);if(console.log("renderWithImages - imageFile found:",!!p),p){const l=URL.createObjectURL(p);return console.log(`renderWithImages - created URL for ${r}:`,l),`<img src="${l}" alt="${r}" class="quiz-preview-image" style="max-width: 300px; height: auto; border-radius: 6px; margin: 8px 0; border: 1px solid #e5e7eb; display: block;" />`}}return console.log(`renderWithImages - image not found for ${i}, imageIndex=${o}, imageNames.length=${t.length}`),`<span class="image-placeholder" style="background: #fee2e2; color: #dc2626; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; border: 1px dashed #dc2626;">🖼️ Image ${n} manquante</span>`})}return(s,e)=>(m(),c("div",null,[e[17]||(e[17]=le(`<h2 class="admin-title" data-v-ec27929b>🚀 Bulk – Création de Quiz QCM</h2><div class="help-section" data-v-ec27929b><p data-v-ec27929b><strong data-v-ec27929b>1.</strong> Sélectionnez le chapitre • <strong data-v-ec27929b>2.</strong> Collez vos quiz au format structuré</p><details class="format-help" data-v-ec27929b><summary data-v-ec27929b>📖 Guide du format (cliquez pour voir)</summary><div class="format-examples" data-v-ec27929b><h4 data-v-ec27929b>Format recommandé avec blocs ===</h4><pre data-v-ec27929b><code data-v-ec27929b>Titre: Quiz Dérivées - Niveau 1
Instructions: Testez vos connaissances sur les dérivées
Difficulté: medium
Images: image1.png, image2.jpg

Question: Quelle est la dérivée de $f(x) = x^2$ ?
A: $2x$
B: $x$
C: $2$
D: $x^2$
Correct: A
Explication: La dérivée de $x^2$ est $2x$ d&#39;après la règle...

Question: Quelle est la dérivée de $f(x) = \\\\sin(x)$ ?
A: $-\\\\cos(x)$
B: $\\\\cos(x)$
C: $\\\\sin(x)$
D: $-\\\\sin(x)$
Correct: B
Explication: La dérivée de $\\\\sin(x)$ est $\\\\cos(x)$...
===
Titre: Quiz Intégrales - Niveau 1
Instructions: Quiz sur les intégrales simples
...
===</code></pre><h4 data-v-ec27929b>Support des images</h4><ul data-v-ec27929b><li data-v-ec27929b>Uploadez vos images via la section &quot;📁 Images pour les quiz&quot;</li><li data-v-ec27929b>Référencez les images avec : <code data-v-ec27929b>Images: nom_image1.png, nom_image2.jpg</code></li><li data-v-ec27929b>Types supportés : JPG, PNG, GIF, WebP (max 10MB)</li><li data-v-ec27929b>Les images seront associées aux questions du quiz</li></ul><h4 data-v-ec27929b>Format alternatif (une ligne par quiz)</h4><p data-v-ec27929b><code data-v-ec27929b>Titre ;; Instructions ;; Difficulté ;; JSON_Questions</code></p></div></details></div>`,2)),a("div",fe,[a("div",_e,[j(a("select",{"onUpdate:modelValue":e[0]||(e[0]=t=>I.value=t),required:"",class:"chapter-select"},[e[3]||(e[3]=a("option",{disabled:"",value:""},"📚 Choisir le chapitre",-1)),(m(!0),c(z,null,k(C.value,t=>(m(),c("option",{key:t.id,value:t.id},d(H(t)),9,xe))),128))],512),[[ue,I.value]]),a("div",ye,[v.value.length?(m(),c("span",Ie," 📊 "+d(v.value.length)+" quiz • "+d(U())+" questions ",1)):f("",!0)])]),E.value?(m(),c("div",be,[a("div",$e,[e[4]||(e[4]=a("strong",null,"Matière:",-1)),e[5]||(e[5]=q()),a("span",null,d(E.value.matiereNom||"—"),1)]),a("div",qe,[e[6]||(e[6]=a("strong",null,"Thème:",-1)),e[7]||(e[7]=q()),a("span",null,d(E.value.themeNom||"—"),1)]),a("div",we,[e[8]||(e[8]=a("strong",null,"Pays:",-1)),e[9]||(e[9]=q()),a("span",null,d(E.value.paysNom||"—"),1)]),a("div",Ee,[e[10]||(e[10]=a("strong",null,"Niveau:",-1)),e[11]||(e[11]=q()),a("span",null,d(E.value.niveauNom||"—"),1)])])):f("",!0),a("div",Ne,[e[13]||(e[13]=a("h4",null,"📁 Images pour les quiz",-1)),e[14]||(e[14]=a("p",{class:"upload-help"},"Uploadez les images qui seront référencées dans vos quiz :",-1)),a("input",{type:"file",ref_key:"imagesInput",ref:Q,onChange:se,accept:"image/*",multiple:"",class:"images-file-input"},null,544),w.value.length>0?(m(),c("div",ze,[e[12]||(e[12]=a("h5",null,"Images sélectionnées :",-1)),(m(!0),c(z,null,k(w.value,(t,i)=>(m(),c("div",{key:i,class:"selected-image-item"},[a("img",{src:ae(t),alt:t.name,class:"image-preview"},null,8,ke),a("span",Ce,d(t.name),1),a("button",{type:"button",class:"btn-remove",onClick:n=>ie(i)},"×",8,Qe)]))),128))])):f("",!0)]),j(a("textarea",{"onUpdate:modelValue":e[1]||(e[1]=t=>y.value=t),placeholder:`📝 Collez vos quiz ici au format structuré...

Exemple rapide :
Titre: Quiz Exemple
Instructions: Quiz d'exemple
Difficulté: easy

Question: Combien font 2+2 ?
A: 3
B: 4
C: 5
D: 6
Correct: B
Explication: 2+2=4, c'est mathématique !
===`,class:"quiz-textarea"},null,512),[[ce,y.value]]),a("div",Me,[a("button",{class:"btn-preview",onClick:ee,disabled:!y.value.trim()}," 👁️ Prévisualiser ",8,Ae),a("button",{class:"btn-create",onClick:K,disabled:!I.value||!v.value.length}," ✨ Créer "+d(v.value.length||"")+" quiz ",9,Te),y.value||v.value.length?(m(),c("button",{key:0,class:"btn-clear",onClick:te}," 🗑️ Vider ")):f("",!0)])]),b.value?(m(),c("div",Le,"✅ "+d(b.value),1)):f("",!0),h.value?(m(),c("div",We,"❌ "+d(h.value),1)):f("",!0),v.value.length?(m(),c("div",Se,[a("div",Ue,[a("h3",Be," 🎯 Aperçu ("+d(v.value.length)+" quiz • "+d(U())+" questions total) ",1),a("button",{class:"btn-toggle-explanations",onClick:e[2]||(e[2]=t=>$.value=!$.value)},d($.value?"🙈 Masquer":"👁️ Voir")+" explications ",1)]),a("div",Pe,[(m(!0),c(z,null,k(v.value,(t,i)=>(m(),c("div",{key:i,class:"quiz-preview-card"},[a("div",Re,[a("h4",je,d(t.titre),1),a("span",{class:V(["difficulty-badge",t.difficulty])},d(X(t.difficulty)),3)]),a("p",Ve,d(t.instruction),1),a("div",Fe,[a("span",Oe,"📝 "+d(t.questions.length)+" questions",1),t.questions.some(n=>n.explanation)?(m(),c("span",De,"💡 "+d(t.questions.filter(n=>n.explanation).length)+" explications",1)):f("",!0),t.image?(m(),c("span",Ge,"🖼️ "+d(t.image.split(",").length)+" images",1)):f("",!0)]),a("div",Je,[(m(!0),c(z,null,k(t.questions.slice(0,2),(n,o)=>(m(),c("div",{key:o,class:"question-mini"},[a("div",He,[a("strong",null,"Q"+d(o+1)+":",1),a("div",{innerHTML:A(n.question,t.image)},null,8,Xe)]),a("div",Ye,[(m(!0),c(z,null,k(n.options,(r,p)=>(m(),c("span",{key:p,class:V(["option-mini",{correct:p===n.correct_answer}])},[q(d(String.fromCharCode(65+p))+": ",1),a("span",{innerHTML:A(r,t.image)},null,8,Ze)],2))),128))]),$.value?(m(),c("div",Ke,[n.explanation?(m(),c("div",et,[e[15]||(e[15]=a("strong",null,"💡 Explication:",-1)),a("div",{innerHTML:A(n.explanation,t.image)},null,8,tt)])):(m(),c("div",st,e[16]||(e[16]=[a("em",null,"⚠️ Aucune explication fournie pour cette question",-1)])))])):f("",!0)]))),128)),t.questions.length>2?(m(),c("div",it,[q(" ... et "+d(t.questions.length-2)+" autres questions ",1),$.value?(m(),c("span",at," ("+d(t.questions.slice(2).filter(n=>n.explanation).length)+" explications dans les autres questions) ",1)):f("",!0)])):f("",!0)])]))),128))])])):f("",!0)]))}},mt=ne(ot,[["__scopeId","data-v-ec27929b"]]);export{mt as default};
