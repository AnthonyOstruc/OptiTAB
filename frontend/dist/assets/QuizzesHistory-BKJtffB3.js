import{a as p,c as V,h as Y,C as N,A as Z,o as c,d as s,j as tt,b as l,F as b,s as x,n as v,i as h,w as et,l as m,t as n}from"./vendor-1gmgAmFu.js";import{D as st}from"./DashboardLayout-CioqXtbg.js";import{B as ot}from"./BaseHistory-BP2m3P1M.js";import{_ as at,b as rt}from"./index-DCsGFNRY.js";import{c as it}from"./quiz-8lezawii.js";import"./menuItems-C0wivC9l.js";import"./matieres-D5ssBX4k.js";import"./ui-jaH5oyHW.js";import"./curriculum-snq3CWRS.js";import"./pdf-B39ievqC.js";import"./mathlive-B5k0jhbN.js";const nt={class:"history-page"},ct={class:"summary-table"},lt={class:"summary-header"},dt={class:"summary-row"},ut={class:"cell matiere"},vt={class:"cell notion"},_t=["onClick"],pt={class:"notion-label"},mt={class:"cell count"},gt={class:"cell correct"},ht={class:"cell incorrect"},yt={key:0,class:"summary-details-row"},ft={class:"details-cell"},kt={class:"chapter-table"},bt={key:0,class:"chapter-loading"},Ct={key:1,class:"chapter-error"},Mt={key:2},$t={class:"cell chapitre"},St={class:"cell count"},Nt={class:"cell correct"},xt={class:"cell incorrect"},zt={class:"cell ratio"},wt=["onClick"],Dt={key:0,class:"inline-mastery-icon"},Bt={class:"inline-mastery-label"},Qt=["onClick"],At={class:"quiz-card-title-section"},Lt=["onClick","title"],Vt={class:"quiz-breadcrumb-compact"},Ft={class:"quiz-card-actions"},Rt=["title"],Tt={key:0,class:"retry-indicator"},Ht={key:0,class:"quiz-card-details"},qt={class:"quiz-breadcrumb"},It={class:"breadcrumb-item"},Et={class:"breadcrumb-item"},jt={class:"breadcrumb-item"},Kt={class:"quiz-meta"},Pt={class:"quiz-attempt"},Gt={key:0,class:"total-attempts"},Jt={class:"quiz-date"},Ot={key:0,class:"quiz-time"},Ut={__name:"QuizzesHistory",setup(Wt){const F=Z(),C=p("all"),R=[{value:"all",label:"Tous",icon:"",class:"all"},{value:"mastered",label:"Maîtrisés",icon:"✅",class:"mastered"},{value:"average",label:"Moyens",icon:"⚠️",class:"average"},{value:"poor",label:"Non maîtrisés",icon:"❌",class:"poor"}],D=e=>{const t=e?.chapitre?.id,o=e?.quiz_id;t&&F.push({path:`/quiz-exercices/${t}`,query:{quizId:o,autoStart:"true"}})},B=p([]),Q=p([]),u=p("count"),_=p("desc"),M=p(new Set),g=p({}),$=p(new Map),T=e=>{const t=Array.isArray(e.quiz_list)?e.quiz_list:[];B.value=t,Q.value=O(t),E(t)},H=V(()=>{let e=B.value;return C.value!=="all"&&(e=e.filter(t=>{const o=Number(t.score_on_10||0);switch(C.value){case"mastered":return o>=7;case"average":return o>=5&&o<7;case"poor":return o<5;default:return!0}})),e}),q=V(()=>[...Q.value||[]].sort((t,o)=>{const a=t[u.value]||0,i=o[u.value]||0;return _.value==="asc"?a-i:i-a})),S=e=>{u.value===e?_.value=_.value==="asc"?"desc":"asc":(u.value=e,_.value="desc")},I=e=>e===0?"0%":`${Math.round(e)}%`,A=e=>e>=90?"excellent":e>=75?"good":e>=50?"average":"poor",E=async e=>{const t=new Map($.value);await Promise.all((e||[]).map(async o=>{try{const a=await it(o.quiz_id);t.set(o.quiz_id,a)}catch{}})),$.value=t},y=e=>{const t=$.value.get(e.quiz_id);return t&&t.can_attempt===!1},z=e=>{const t=$.value.get(e.quiz_id);return!t||t.can_attempt!==!1?"":t.time_remaining_formatted||t.message||"Verrouillé"},j=e=>{if(y(e)){alert(z(e)||"Quiz verrouillé");return}D(e)},K=e=>{C.value=e},P=e=>e>=7?"score-good":e>=5?"score-average":"score-poor",w=e=>`${e.matiere.id}-${e.notion.id}`,L=e=>M.value.has(w(e)),f=e=>{const t=w(e);return g.value[t]||(g.value[t]={loading:!1,error:"",chapters:[]}),g.value[t]},G=async e=>{const t=w(e);if(M.value.has(t)){M.value.delete(t);return}M.value.add(t);const o=f(e);o.chapters&&o.chapters.length>0||await J(e.matiere.id,e.notion.id)},J=async(e,t)=>{const o=`${e}-${t}`;g.value[o]={loading:!0,error:"",chapters:[]};try{const a=await rt.get("/api/suivis/quiz/stats/",{params:{matiere:e,notion:t}}),i=Array.isArray(a?.data?.quiz_list)?a.data.quiz_list:[],d=U(i);g.value[o]={loading:!1,error:"",chapters:d}}catch(a){const i=a?.response?.data?.error||"Erreur lors du chargement des détails";g.value[o]={loading:!1,error:i,chapters:[]}}},O=e=>{const t=new Map;for(const a of e){const i=a?.matiere||{},d=a?.notion||{},r=`${i.id}-${d.id}`;t.has(r)||t.set(r,{matiere:{id:i.id,titre:i.titre||""},notion:{id:d.id,titre:d.titre||""},count:0,correct_count:0,incorrect_count:0});const k=t.get(r);k.count+=1,(a.score_on_10||0)>=7?k.correct_count+=1:k.incorrect_count+=1}const o=Array.from(t.values()).map(a=>({...a,average_percent:a.count>0?a.correct_count/a.count*100:0}));return o.sort((a,i)=>String(a.matiere.titre).localeCompare(String(i.matiere.titre),"fr",{sensitivity:"base"})||String(a.notion.titre).localeCompare(String(i.notion.titre),"fr",{sensitivity:"base"})),o},U=e=>{const t=new Map;for(const a of e){const i=a?.chapitre||{},d=i?.id;if(!d)continue;t.has(d)||t.set(d,{chapitre:{id:d,titre:i?.titre||"Chapitre"},count:0,correct_count:0,incorrect_count:0,sum_score_10:0});const r=t.get(d);r.count+=1,r.sum_score_10+=Number(a.score_on_10||0),(a.score_on_10||0)>=7?r.correct_count+=1:r.incorrect_count+=1}const o=Array.from(t.values()).map(a=>{const i=a.count>0?a.correct_count/a.count:0,d=a.count>0?a.sum_score_10/a.count:0;return{...a,ratio_percent:i*100,average_10:Math.round(d*10)/10,average_percent:i*100}});return o.sort((a,i)=>String(a.chapitre.titre).localeCompare(String(i.chapitre.titre),"fr",{sensitivity:"base"})),o},W=e=>new Date(e).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),X=e=>{const t=Math.floor(e/60),o=e%60;return`${t}:${o.toString().padStart(2,"0")}`};return(e,t)=>(c(),Y(st,null,{default:N(()=>[s("div",nt,[t[16]||(t[16]=s("h2",{class:"page-title"},"Historique complet des quiz",-1)),tt(ot,{title:"🧠 Historique des Quiz","list-title":"📝 Tous mes quiz","loading-text":"Chargement de l'historique...","api-endpoint":"/api/suivis/quiz/stats/","items-per-page":20,"navigation-handler":D,"custom-filters":R,"filtered-items":H.value,onDataLoaded:T},{"matiere-notion-stats":N(()=>[s("div",ct,[s("div",lt,[t[8]||(t[8]=s("div",null,"Matière",-1)),t[9]||(t[9]=s("div",null,"Notion",-1)),s("div",{class:"sortable-header",onClick:t[0]||(t[0]=o=>S("count"))},[t[4]||(t[4]=m(" Faits ")),s("span",{class:v(["sort-icon",{active:u.value==="count"}])},n(u.value==="count"&&_.value==="asc"?"↑":"↓"),3)]),s("div",{class:"sortable-header",onClick:t[1]||(t[1]=o=>S("correct_count"))},[t[5]||(t[5]=m(" Réussis ")),s("span",{class:v(["sort-icon",{active:u.value==="correct_count"}])},n(u.value==="correct_count"&&_.value==="asc"?"↑":"↓"),3)]),s("div",{class:"sortable-header",onClick:t[2]||(t[2]=o=>S("incorrect_count"))},[t[6]||(t[6]=m(" Ratés ")),s("span",{class:v(["sort-icon",{active:u.value==="incorrect_count"}])},n(u.value==="incorrect_count"&&_.value==="asc"?"↑":"↓"),3)]),s("div",{class:"sortable-header",onClick:t[3]||(t[3]=o=>S("average_percent"))},[t[7]||(t[7]=m(" Moyenne ")),s("span",{class:v(["sort-icon",{active:u.value==="average_percent"}])},n(u.value==="average_percent"&&_.value==="asc"?"↑":"↓"),3)])]),(c(!0),l(b,null,x(q.value,o=>(c(),l(b,{key:`${o.matiere.id}-${o.notion.id}`},[s("div",dt,[s("div",ut,n(o.matiere.titre),1),s("div",vt,[s("button",{class:"notion-toggle",onClick:a=>G(o)},[s("span",pt,n(o.notion.titre),1),(c(),l("svg",{class:v(["chevron",{expanded:L(o)}]),width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},t[10]||(t[10]=[s("polyline",{points:"6,9 12,15 18,9"},null,-1)]),2))],8,_t)]),s("div",mt,n(o.count),1),s("div",gt,n(o.correct_count),1),s("div",ht,n(o.incorrect_count),1),s("div",{class:v(["cell average",A(o.average_percent)])},n(I(o.average_percent)),3)]),L(o)?(c(),l("div",yt,[s("div",ft,[s("div",kt,[t[11]||(t[11]=s("div",{class:"chapter-header"},[s("div",null,"Chapitre"),s("div",null,"Faits"),s("div",null,"Réussis"),s("div",null,"Ratés"),s("div",null,"Réussite"),s("div",null,"Moyenne")],-1)),f(o).loading?(c(),l("div",bt,"Chargement des détails...")):f(o).error?(c(),l("div",Ct,n(f(o).error),1)):(c(),l("div",Mt,[(c(!0),l(b,null,x(f(o).chapters,a=>(c(),l("div",{key:a.chapitre.id,class:"chapter-row"},[s("div",$t,n(a.chapitre.titre),1),s("div",St,n(a.count),1),s("div",Nt,n(a.correct_count),1),s("div",xt,n(a.incorrect_count),1),s("div",zt,n(Math.round(a.ratio_percent))+"%",1),s("div",{class:v(["cell average",A(a.average_percent)])},n(Math.round(a.average_10*10)/10)+"/10",3)]))),128))]))])])])):h("",!0)],64))),128))])]),"custom-filters":N(({filters:o,selected:a})=>[(c(!0),l(b,null,x(o,i=>(c(),l("button",{key:i.value,onClick:d=>K(i.value),class:v(["inline-mastery-btn",{active:C.value===i.value},i.class])},[i.icon?(c(),l("span",Dt,n(i.icon),1)):h("",!0),s("span",Bt,n(i.label),1)],10,wt))),128))]),"items-list":N(({items:o,toggleDetails:a,isExpanded:i,navigateToItem:d})=>[(c(!0),l(b,null,x(o,r=>(c(),l("div",{key:r.id,class:v(["quiz-card",{"multiple-attempts":r.total_attempts>1,locked:y(r)}])},[s("div",{class:"quiz-card-header",onClick:k=>a(r.id)},[s("div",At,[s("h5",{class:v(["quiz-card-title clickable-title",{locked:y(r)}]),onClick:et(k=>j(r),["stop"]),title:y(r)?"Verrouillé":"Accéder au quiz: "+r.quiz_titre},[m(n(r.quiz_titre)+" ",1),t[12]||(t[12]=s("svg",{class:"navigation-icon",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[s("path",{d:"M7 17l9.2-9.2M17 17V7H7"})],-1))],10,Lt),s("div",Vt,n(r.matiere.titre)+" → "+n(r.notion.titre),1)]),s("div",Ft,[y(r)?(c(),l("div",{key:0,class:"lock-badge",title:z(r)},"🔒 "+n(z(r)),9,Rt)):(c(),l("div",{key:1,class:v(["quiz-score",P(r.score_on_10)])},[m(n(r.score_on_10)+"/10 ",1),r.total_attempts>1?(c(),l("span",Tt,"↻")):h("",!0)],2)),s("button",{class:v(["expand-toggle",{expanded:i(r.id)}])},t[13]||(t[13]=[s("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[s("polyline",{points:"6,9 12,15 18,9"})],-1)]),2)])],8,Qt),i(r.id)?(c(),l("div",Ht,[s("div",qt,[s("span",It,n(r.matiere.titre),1),t[14]||(t[14]=s("span",{class:"breadcrumb-separator"},"→",-1)),s("span",Et,n(r.notion.titre),1),t[15]||(t[15]=s("span",{class:"breadcrumb-separator"},"→",-1)),s("span",jt,n(r.chapitre.titre),1)]),s("div",Kt,[s("span",Pt,[m(" Tentative #"+n(r.tentative_numero)+" ",1),r.total_attempts>1?(c(),l("span",Gt,"("+n(r.total_attempts)+" au total)",1)):h("",!0)]),s("span",Jt,n(W(r.date_creation)),1),r.temps_total_seconde?(c(),l("span",Ot,n(X(r.temps_total_seconde)),1)):h("",!0)])])):h("",!0)],2))),128))]),_:1},8,["filtered-items"])])]),_:1}))}},ce=at(Ut,[["__scopeId","data-v-9c74b20a"]]);export{ce as default};
