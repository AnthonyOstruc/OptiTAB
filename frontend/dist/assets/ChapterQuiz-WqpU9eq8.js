import{_ as gt,q as _t,E as wt,h as p,m as z,s as se,p as zt,M as Qt,B as O,D as yt,f as bt,w as qt,C as At,o as a,a as n,i as xt,c as i,b as Q,F as ve,e as pe,j as $,t as l,u as ne,d as oe,n as Oe}from"./index-C20tTf3S.js";import{D as Ct}from"./DashboardLayout-DmmXvv68.js";import{g as St,a as It,c as kt,b as Tt,s as $t}from"./quiz-BenXfgLR.js";import{d as Lt}from"./curriculum-C6dJwtfd.js";import{useDailyObjectivesIntegration as Mt}from"./useDailyObjectives-B4lktBMi.js";import{B as Pt}from"./BackButton-B9UoO6zr.js";import"./menuItems-zei-A9he.js";import"./matieres-Ce1WeeoH.js";const Dt={class:"chapter-quiz-section"},Nt={key:0,class:"clean-navigation"},Rt={class:"nav-grid"},Et=["onClick"],Vt={class:"nav-icon"},Xt={class:"nav-label"},jt={class:"nav-count"},Jt={class:"quiz-header"},Ot={class:"quiz-title"},Bt={class:"quiz-subtitle"},Ut={key:1,class:"quiz-list"},Ft=["onClick"],Ht={class:"quiz-card-header"},Gt={class:"quiz-card-title"},Kt={class:"quiz-card-description"},Wt={class:"quiz-card-meta"},Yt={class:"quiz-questions"},Zt={class:"quiz-time"},es={key:0,class:"quiz-status-container"},ts={class:"cooldown-time-left"},ss={class:"cooldown-time"},ns={class:"quiz-right-info"},os={class:"quiz-attempts"},as={class:"attempts-number"},is={class:"score-value"},ls={key:1,class:"quiz-status-container"},us={class:"quiz-progress-info"},rs={class:"progress-text"},cs={key:0,class:"just-started-indicator"},ds={key:1,class:"completed-indicator"},vs={key:2,class:"lost-question-indicator"},ps={key:0,class:"first-question-lost"},fs={key:1},ms={key:3,class:"saved-question-indicator"},hs={class:"quiz-right-info"},gs={class:"quiz-saved-time"},_s={class:"saved-time"},ws={class:"continue-text"},zs={class:"continue-arrow"},Qs={key:2,class:"quiz-status-container"},ys={class:"quiz-right-info"},bs={class:"quiz-attempts"},qs={class:"attempts-number"},As={class:"score-value"},xs={key:0,class:"pagination-container"},Cs={class:"pagination-info"},Ss={class:"pagination-controls"},Is=["disabled"],ks={class:"pagination-numbers"},Ts=["onClick"],$s=["disabled"],Ls={key:1,class:"no-quiz-message"},Ms={class:"no-quiz-icon"},Ps={key:2,class:"quiz-interface"},Ds={key:0,class:"session-restored-banner"},Ns={class:"session-restored-content"},Rs={class:"session-restored-text"},Es={key:0},Vs={key:1},Xs={key:2},js={key:0},Js={key:1},Os={class:"quiz-progress"},Bs={class:"progress-bar"},Us={class:"progress-text"},Fs={class:"question-timer"},Hs={class:"timer-info"},Gs={class:"timer-bar"},Ks={class:"timer-difficulty"},Ws={class:"question-container"},Ys=["innerHTML"],Zs={class:"options-container"},en=["onClick"],tn={class:"option-letter"},sn=["innerHTML"],nn={key:0,class:"timeout-message"},on={key:1,class:"explanation"},an=["innerHTML"],ln={class:"quiz-actions"},un=["disabled"],rn={key:1,class:"answer-actions"},cn={key:3,class:"quiz-results"},dn={class:"results-header"},vn={class:"score-percentage"},pn={key:0,class:"gamification-results"},fn={class:"xp-icon"},mn={key:0},hn={key:1},gn={class:"xp-details"},_n={class:"xp-amount"},wn={key:0},zn={key:1},Qn={class:"xp-info"},yn={key:0},bn={key:1},qn={key:2},An={key:3},xn={key:0,class:"level-up-display"},Cn={class:"level-up-text"},Sn={class:"results-stats"},In={class:"stat-card"},kn={class:"stat-number"},Tn={class:"stat-card"},$n={class:"stat-number"},Ln={class:"stat-card"},Mn={class:"stat-number"},Pn={key:0,class:"stat-card lost-questions"},Dn={class:"stat-number"},Nn={class:"stat-card gamification"},Rn={class:"stat-number"},En={key:1,class:"lost-questions-info"},Vn={class:"lost-questions-info-text"},fe=5,Xn={__name:"ChapterQuiz",setup(jn){const j=Qt(),ye=At(),L=_t(),{handleQuizCompletion:Be,updateUserXPInstantly:Ue}=wt(),{onQuizCompleted:Fe}=Mt(),h=p([]),be=p(""),me=p([]),c=p(null),g=p(0),M=p(null),y=p(!1),_=p([]),A=p(!1),I=p(1),V=p(0),qe=p(!1),B=p(!1),U=p(null),K=p(null),he=p(!1),F=p(null),ge=p(null),He=p(0);let J=null;const W=z(()=>{const t=(c.value?.difficulty||c.value?.difficulte||"easy").toString().toLowerCase();return["easy","facile"].includes(t)?"easy":["medium","moyen"].includes(t)?"medium":["hard","difficile"].includes(t)?"hard":"easy"}),Ae=z(()=>({easy:20,medium:25,hard:30})[W.value]||20),xe=z(()=>Ae.value);z(()=>(He.value,ge.value?Math.max(0,Math.floor((Date.now()-ge.value)/1e3)):0));const P=p(0),Ge=z(()=>`${xe.value}s`),Ce=p(0),_e=p(!0);function Se(){J&&(clearInterval(J),J=null),P.value=xe.value,_e.value=!0,ge.value=Date.now(),Ce.value++,J=setInterval(()=>{P.value--,P.value<=0&&Ke()},1e3)}function Ke(){console.log("⏰ Temps écoulé pour la question",g.value+1),ae(),_.value.push({questionIndex:g.value,selectedAnswer:null,correctAnswer:D.value.correct_answer,correct:!1,timeOut:!0}),y.value=!0,M.value=null,X(),console.log("⏰ Temps écoulé - Affichage de la bonne réponse, attente action utilisateur")}function ae(){J&&(clearInterval(J),J=null),_e.value=!1}const b=p("todo"),q=p([]),Ie=p(!1),k=p(new Map),ke=p(!1);let H=null;const ie=p(new Set),f=ie;function le(){try{const t=new Set;h.value.forEach(e=>{pt(e.id)&&t.add(e.id)}),ie.value=t,console.log("🔄 Rafraîchissement des quiz sauvegardés:",t.size)}catch(t){console.warn("⚠️ Impossible de rafraîchir les quiz sauvegardés:",t)}}const D=z(()=>!c.value||!c.value.questions?null:c.value.questions[g.value]),Te=z(()=>h.value.reduce((t,e)=>t+(e.questions?.length||0),0)),we=z(()=>_.value.filter(t=>t.correct).length),We=z(()=>_.value.filter(t=>!t.correct).length),ze=z(()=>_.value.length),ue=z(()=>c.value?c.value.questions.length-_.value.length:0),$e=z(()=>ze.value>0?we.value/ze.value*100:0),Le=z(()=>{const t=h.value.filter(d=>!R(d.id)&&!(f.value&&f.value.has(d.id))),e=h.value.filter(d=>{if(f.value&&f.value.has(d.id)||!R(d.id))return!1;const m=q.value.filter(w=>w.quiz===d.id);if(m.length>0){const w=m[m.length-1],T=d.questions?.length||0;if((w.total_points||0)<T)return!1}return E(d.id)<5}),s=h.value.filter(d=>{if(f.value&&f.value.has(d.id)||!R(d.id))return!1;const m=q.value.filter(w=>w.quiz===d.id);if(m.length>0){const w=m[m.length-1],T=d.questions?.length||0;if((w.total_points||0)<T)return!1}return E(d.id)>=5}),o=h.value.filter(d=>{if(f.value&&f.value.has(d.id))return!0;if(R(d.id)){const m=q.value.filter(C=>C.quiz===d.id);if(m.length>0){const C=m[m.length-1],w=d.questions?.length||0;if((C.total_points||0)<w)return!0}}return!1}),r=f.value&&f.value.size>0,u=o.length>0||r,v=[{key:"todo",label:"Quiz à faire",shortLabel:"À faire",icon:"📝",count:t.length,description:"Quiz jamais commencés"}];return u&&v.push({key:"continue",label:"Quiz à continuer",shortLabel:"À continuer",icon:"🔄",count:o.length,priority:"high",description:"Quiz commencés mais pas terminés"}),e.length>0&&v.push({key:"below-average",label:"Sous la moyenne",shortLabel:"À revoir",icon:"📈",count:e.length,description:"Quiz à refaire (note < 5/10)"}),s.length>0&&v.push({key:"done",label:"Quiz réussis",shortLabel:"Réussis",icon:"✅",count:s.length,description:"Quiz maîtrisés (note ≥ 5/10)"}),v});se(q,()=>{const t=Le.value;!t.some(s=>s.key===b.value)&&t.length>0&&(b.value=t[0].key)},{deep:!0});const N=p(1),Y=z(()=>{switch(b.value){case"todo":return h.value.filter(t=>!R(t.id)&&!(f.value&&f.value.has(t.id)));case"continue":return h.value.filter(t=>{if(f.value&&f.value.has(t.id))return!0;if(R(t.id)){const e=q.value.filter(s=>s.quiz===t.id);if(e.length>0){const s=e[e.length-1],o=t.questions?.length||0;return(s.total_points||0)<o}}return!1});case"below-average":return h.value.filter(t=>{if(f.value&&f.value.has(t.id)||!R(t.id))return!1;const e=q.value.filter(o=>o.quiz===t.id);if(e.length>0){const o=e[e.length-1],r=t.questions?.length||0;if((o.total_points||0)<r)return!1}return E(t.id)<5});case"done":return h.value.filter(t=>{if(f.value&&f.value.has(t.id)||!R(t.id))return!1;const e=q.value.filter(o=>o.quiz===t.id);if(e.length>0){const o=e[e.length-1],r=t.questions?.length||0;if((o.total_points||0)<r)return!1}return E(t.id)>=5});default:return h.value}}),Ye=z(()=>{const t=(N.value-1)*fe,e=t+fe;return Y.value.slice(t,e)}),re=z(()=>Math.ceil(Y.value.length/fe));function Ze(t){N.value=t}function et(){N.value>1&&N.value--}function tt(){N.value<re.value&&N.value++}se(b,()=>{N.value=1});function st(){console.log("🔍 Debug - État des quiz (logique pédagogique):"),h.value.forEach(t=>{const e=R(t.id),s=f.value&&f.value.has(t.id),o=q.value.filter(d=>d.quiz===t.id),r=E(t.id);let u=!1;if(e&&o.length>0){const d=o[o.length-1],m=t.questions?.length||0;u=(d.total_points||0)<m}let v="À faire";s&&!e?v="À continuer (sauvegardé)":u?v="À continuer (incomplet)":e&&(v=r<5?"Sous la moyenne (À revoir)":"Réussis"),console.log(`Quiz ${t.id} (${t.titre}):`,{hasAttempt:e,hasSave:s,attemptsCount:o.length,lastScore:r,category:v,belowAverage:e&&r<5,isIncomplete:u,totalQuestions:t.questions?.length||0,questionsAnswered:o.length>0&&o[o.length-1].total_points||0})})}function R(t){return q.value.some(e=>e.quiz===t)}function Me(t){return q.value.filter(e=>e.quiz===t).length}function E(t){const e=q.value.filter(r=>r.quiz===t).sort((r,u)=>{const v=new Date(r.date_creation||r.created_at||0);return new Date(u.date_creation||u.created_at||0)-v});if(!e.length)return 0;const s=e[0];if(!s||!s.total_points)return 0;const o=(Number(s.score)||0)/(Number(s.total_points)||1)*10;return Math.round(o*10)/10}const Z=()=>{O(()=>{window.MathJax&&window.MathJax.typesetPromise()})};se(D,()=>{D.value&&Z()},{deep:!0}),se(y,()=>{y.value&&Z()});async function ce(){try{Ie.value=!0;const t=j.params.chapitreId,e=await Tt(t),s=Array.isArray(e)?e:e?.data||e?.results||[];q.value=s}catch(t){t.response?.status===401?(console.warn("⚠️ Utilisateur non authentifié, mode local activé"),q.value=[]):(console.error("❌ Erreur lors du chargement des tentatives:",t),q.value=[])}finally{Ie.value=!1}}zt(async()=>{window.addEventListener("beforeunload",Je),window.addEventListener("pagehide",()=>{c.value&&!A.value&&X()});try{const t=j.params.chapitreId,e=j.query.quizId;console.log(`[ChapterQuiz] 🚀 Chargement optimisé - Chapitre: ${t}, Quiz cible: ${e||"Aucun"}`);const[s,o]=await Promise.all([Lt(t).catch(()=>null),St(t)]);me.value=s?[s]:[],be.value=s?.nom||"Chapitre";const r=Array.isArray(o.data)?o.data:o.data?.quiz||[];if(h.value=r.map(u=>({...u,questions:Array.isArray(u?.questions)?u.questions:Array.isArray(u?.questions_data)?u.questions_data:[]})),console.log(`[ChapterQuiz] ✅ Quiz chargés: ${h.value.length}`),le(),e){const u=h.value.find(v=>v.id==e);if(u){const v=j.query.autoStart==="true";if(console.log(`[ChapterQuiz] 🎯 Quiz trouvé: ${u.titre} (Auto-start: ${v})`),v){console.log("[ChapterQuiz] ⚡ Mode turbo activé"),ee().then(()=>{console.log("[ChapterQuiz] 🔒 Cooldowns vérifiés")}),Qe(u);return}else{Promise.all([ce(),ee()]).then(()=>{console.log("[ChapterQuiz] 📊 Toutes les données chargées")}),await O(),await Qe(u);return}}else console.warn(`[ChapterQuiz] ⚠️ Quiz ${e} non trouvé`)}await Promise.all([ce(),ee()]),le(),ft(),await O(),Z()}catch(t){console.error("[ChapterQuiz] ❌ Erreur de chargement:",t),h.value=[]}});function Pe(t){return{easy:"Facile",medium:"Moyen",hard:"Difficile"}[t]||t}function nt(t){if(!t)return"Inconnu";const s=new Date-t,o=Math.floor(s/(1e3*60)),r=Math.floor(s/(1e3*60*60)),u=Math.floor(s/(1e3*60*60*24));return o<1?"À l'instant":o<60?`Il y a ${o}min`:r<24?`Il y a ${r}h`:u<7?`Il y a ${u}j`:t.toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"})}function ot(t){return`${Math.ceil(t*1.5)} min`}function Qe(t){L.isAuthenticated||console.warn("⚠️ Utilisateur non authentifié, démarrage du quiz en mode local");const e=k.value.get(t.id);if(e&&!e.can_attempt){alert(`⏰ ${e.message}`);return}console.log(`[ChapterQuiz] 🚀 Démarrage rapide du quiz: ${t.titre}`),c.value={...t,questions:Array.isArray(t?.questions)?t.questions:Array.isArray(t?.questions_data)?t.questions_data:[]};const s=dt(c.value);s?(M.value=null,y.value=!1,A.value||(B.value=!1),console.log(`🔄 Quiz restauré - Session: ${K.value}`),console.log(`📍 Reprise à la question ${g.value+1}/${c.value.questions.length}`),_.value.length===0&&g.value===1&&console.log('⚠️ Première question perdue - Quiz considéré comme "débuté"')):(g.value=0,M.value=null,y.value=!1,_.value=[],A.value=!1,B.value=!1,U.value=Date.now(),K.value=ct(),console.log(`🆕 Nouveau quiz démarré - Session: ${K.value}`),X()),X(),Se(),It(t.id).then(o=>{const r=Array.isArray(o)?o:o?.data||o?.results||[];s||(I.value=(r.length||0)+1)}).catch(o=>{console.warn("⚠️ Impossible de charger les tentatives (probablement non connecté):",o.message),s||(I.value=1)}),O(()=>{Z()})}function at(t){!y.value&&P.value>0&&(M.value=t)}function it(){if(M.value===null)return;if(vt()){alert("🚨 Tentative de triche détectée. Le quiz va redémarrer."),G(c.value.id),location.reload();return}ae(),y.value=!0;const t=M.value===D.value.correct_answer;_.value.push({questionIndex:g.value,selectedAnswer:M.value,correctAnswer:D.value.correct_answer,correct:t,timestamp:Date.now()}),X()}function lt(){g.value<c.value.questions.length-1?(g.value++,M.value=null,y.value=!1,X(),Z(),Se()):De()}async function De(){A.value=!0,ae(),G(c.value.id);const t=U.value?Math.floor((Date.now()-U.value)/1e3):0,e=c.value.questions.length,s=we.value;console.log("🎯 Soumission quiz:",{quiz_id:c.value.id,score:s,total_points:e,temps_total_seconde:t,pourcentage_score:e>0?s/e*100:0,tentative_prevue:I.value,questions_answered:_.value.length,questions_lost:e-_.value.length});try{const o=L.level,r=await $t({quiz_id:c.value.id,score:s,total_points:e,temps_total_seconde:t});console.log("🎯 Résultat soumission:",r),console.log("🎯 XP dans la réponse:",r?.xp_gagne,r?.data?.xp_gagne),console.log("🎯 Tentative dans la réponse:",r?.tentative_numero,r?.data?.tentative_numero);const u=Number(r?.xp_gagne??r?.data?.xp_gagne??0),v=Number(r?.tentative_numero??r?.data?.tentative_numero??I.value);console.log("🎯 XP récupérés:",u,"pour tentative:",v),V.value=u,I.value=v,B.value=!0;const d=e>0?s/e*100:0,m={isSuccess:d>=50,score:s,percentage:d,timeSpent:t,difficulty:W.value,totalQuestions:e,correctAnswers:s};console.log("🎯 [DailyObjectives] Déclenchement avec:",m),console.log("🎯 [DailyObjectives] Quiz difficulté brute:",c.value?.difficulty||c.value?.difficulte),console.log("🎯 [DailyObjectives] Quiz difficulté normalisée:",W.value),Fe(m),console.log("🎯 Avant mise à jour instantanée:",{currentXP:L.xp,currentLevel:L.level,xpToGain:u});const C=await Ue(u,"quiz_completion");console.log("🎯 Après mise à jour instantanée:",{newXP:L.xp,newLevel:L.level,newXpToNext:L.xp_to_next,updateResult:C}),C.success&&C.levelUp&&(qe.value=!0);try{await Be(c.value.id,u,v,c.value.titre||"Quiz")}catch(w){console.warn("⚠️ Notification XP a échoué:",w)}v>=3&&u>0&&console.warn("⚠️ Incohérence détectée: XP > 0 pour tentative >= 3"),console.log("🧮 XP reçus:",{received:u,score:s,totalPoints:e,tentative:v}),await ce(),le(),console.log("🎯 Quiz terminé, rechargement effectué"),console.log("🎯 Nombre total de tentatives après rechargement:",q.value.length),st(),O(()=>{console.log("🔄 Mise à jour réactive des onglets après fin de quiz")})}catch(o){if(console.error("Erreur lors de la soumission du quiz:",o),o.response?.status===400&&o.response?.data?.detail){alert(o.response.data.detail),await ee(),await Ne();return}V.value=0,B.value=!1}await ee()}async function Ne(){c.value&&!A.value&&G(c.value.id),c.value=null,A.value=!1,await ce(),O(()=>{console.log("🔄 Mise à jour réactive des onglets après retour à la liste")}),console.log("🔄 Retour à la liste, tentatives rechargées")}function ut(t){return t>=80?"excellent":t>=60?"good":t>=40?"average":"poor"}function Re(t){const e=Number(t);return e<5?"score-below-average":e===5?"score-average":"score-above-average"}async function ee(){if(h.value.length){ke.value=!0;try{for(const t of h.value)try{const e=await kt(t.id);k.value.set(t.id,e)}catch(e){e.response?.status===401?(console.warn(`⚠️ Utilisateur non authentifié pour quiz ${t.id}, cooldown désactivé`),k.value.set(t.id,{can_attempt:!0,message:"Mode local"})):(console.warn(`Erreur cooldown pour quiz ${t.id}:`,e),k.value.set(t.id,{can_attempt:!0}))}Xe(),console.log("🎯 Système de cooldown automatique démarré")}catch(t){console.error("Erreur lors du chargement des cooldowns:",t)}finally{ke.value=!1}}}function Ee(t){return k.value.get(t)||{can_attempt:!0}}function Ve(t){return!Ee(t).can_attempt}function Xe(){H&&clearInterval(H);const t=Array.from(k.value.values()).some(s=>!s.can_attempt),e=t?1e4:6e4;H=setInterval(()=>{mt(),!Array.from(k.value.values()).some(o=>!o.can_attempt)&&e!==6e4&&Xe()},e),console.log(`🎯 Timer cooldown: ${e/1e3}s (cooldowns actifs: ${t})`)}function rt(){H&&(clearInterval(H),H=null)}function ct(){return`quiz_${c.value?.id}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}function X(){if(!c.value||A.value)return;const t={sessionId:K.value,quizId:c.value.id,chapitreId:j.params.chapitreId,currentQuestionIndex:g.value,userAnswers:[..._.value],quizStartTime:U.value,currentAttempt:I.value,timestamp:Date.now(),questionsCompleted:_.value.length,expectedNextQuestion:g.value+1,userId:L.id};try{localStorage.setItem(`optitab_quiz_save_${c.value.id}`,JSON.stringify(t)),F.value=t;const e=new Set(f.value);e.add(c.value.id),ie.value=e,te.delete(c.value.id),console.log(`💾 État du quiz sauvegardé - Question ${g.value+1}`)}catch(e){console.error("❌ Erreur lors de la sauvegarde:",e)}}function dt(t){try{const e=localStorage.getItem(`optitab_quiz_save_${t.id}`);if(!e)return!1;let s=JSON.parse(e);if(!je(s,t)){console.warn("⚠️ État sauvegardé invalide - Tentative de récupération");const T=t.questions?.length||0,S={...s};if(s.currentQuestionIndex>=T&&(S.currentQuestionIndex=Math.min(s.userAnswers.length,T-1),console.log("🔧 Index de question corrigé:",s.currentQuestionIndex,"→",S.currentQuestionIndex)),Math.abs(s.currentQuestionIndex-s.userAnswers.length)>3&&s.currentQuestionIndex<T&&(S.currentQuestionIndex=s.userAnswers.length,console.log("🔧 Index de question ajusté:",s.currentQuestionIndex,"→",S.currentQuestionIndex)),je(S,t))console.log("✅ État récupéré avec succès"),s=S,localStorage.setItem(`optitab_quiz_save_${t.id}`,JSON.stringify(S));else return console.warn("⚠️ Impossible de récupérer l'état - Suppression pour sécurité"),G(t.id),!1}const o=3600*1e3;if(Date.now()-s.timestamp>o)return console.warn("⚠️ Sauvegarde expirée - Nettoyage"),G(t.id),!1;he.value=!0;const r=s.userAnswers.some(T=>T.questionIndex===s.currentQuestionIndex),u=t.questions?.length||0,v=s.currentQuestionIndex>=u-1,d=s.userAnswers.length>=u;if(v||d)return console.log("🎯 Dernière question perdue ou quiz terminé - Affichage des résultats"),_.value=[...s.userAnswers],U.value=s.quizStartTime,I.value=s.currentAttempt,A.value=!0,B.value=!1,G(t.id),!0;const m=Math.min(s.currentQuestionIndex+1,u-1);K.value=s.sessionId,g.value=m,_.value=[...s.userAnswers],U.value=s.quizStartTime,I.value=s.currentAttempt,F.value=s;const C=!r,w=s.currentQuestionIndex+1;return console.log(`🔄 État du quiz restauré - Reprise à la question ${g.value+1}`),console.log(`📊 Réponses précédentes: ${_.value.length}`),console.log(C?`⚠️ Question ${w} perdue (non répondue) pour éviter la tricherie`:`✅ Question ${w} sauvegardée (réponse donnée)`),!0}catch(e){return console.error("❌ Erreur lors de la restauration:",e),!1}}function je(t,e){if(t.userId!==L.id)return console.warn("⚠️ Utilisateur différent détecté"),!1;if(t.quizId!==e.id)return console.warn("⚠️ Quiz ID différent"),!1;if(t.questionsCompleted!==t.userAnswers.length)return console.warn("⚠️ Incohérence dans le nombre de questions"),!1;if(t.currentQuestionIndex>=e.questions.length)return console.warn("⚠️ Index de question hors limites"),!1;const s=t.userAnswers.length,o=Math.abs(t.currentQuestionIndex-s),r=e.questions?.length||0,u=t.currentQuestionIndex>=r-1,v=t.userAnswers.length>=r;if(u||v){if(o>3)return console.warn("⚠️ Index de question incohérent - écart trop important (quiz terminé)"),!1}else if(o>2)return console.warn("⚠️ Index de question incohérent - écart trop important"),!1;return console.log("✅ État sauvegardé valide"),!0}function G(t){try{localStorage.removeItem(`optitab_quiz_save_${t}`),F.value=null;const e=new Set(f.value);e.delete(t),ie.value=e,te.delete(t),console.log("🧹 Sauvegarde nettoyée")}catch(e){console.error("❌ Erreur lors du nettoyage:",e)}}function vt(){return F.value?g.value>F.value.expectedNextQuestion?(console.warn("🚨 Tentative de triche détectée - Saut de question"),!0):_.value.length<F.value.questionsCompleted?(console.warn("🚨 Tentative de triche détectée - Réponses manquantes"),!0):g.value>=c.value.questions.length?(console.warn("🚨 Tentative de triche détectée - Index de question invalide"),!0):!1:!1}function pt(t){try{const e=localStorage.getItem(`optitab_quiz_save_${t}`);if(!e)return!1;const s=JSON.parse(e);return Date.now()-s.timestamp>36e5||s.userId!==L.id?!1:s.currentQuestionIndex>=0}catch{return!1}}se(f,(t,e)=>{t.size!==e.size&&console.log("🔄 Quiz sauvegardés mis à jour:",{avant:e.size,apres:t.size})},{deep:!0});const ft=()=>{O(()=>{h.value.length>0&&(console.log("⚡ Préchargement des quiz sauvegardés..."),le())})},te=new Map;function x(t){if(te.has(t)){const e=te.get(t);if(Date.now()-e.timestamp<5e3)return e.data}try{const e=localStorage.getItem(`optitab_quiz_save_${t}`);if(!e)return null;const s=JSON.parse(e),o=h.value.find(de=>de.id===t)?.questions?.length||0,r=Math.min(s.currentQuestionIndex+1,o),u=s.userAnswers.some(de=>de.questionIndex===s.currentQuestionIndex),v=!u,d=s.currentQuestionIndex===0&&!u,m=s.currentQuestionIndex===0&&s.userAnswers.length===0,C=s.currentQuestionIndex>=o-1,w=s.userAnswers.length>=o,T=C||w,S={currentQuestion:r,totalQuestions:o,answersGiven:s.userAnswers.length,lastSaved:new Date(s.timestamp),progress:r,lostQuestion:s.currentQuestionIndex+1,isFirstQuestionLost:d,questionLost:v,hasAnsweredCurrentQuestion:u,isJustStarted:m,isQuizCompleted:T};return te.set(t,{data:S,timestamp:Date.now()}),S}catch(e){return console.warn("Erreur lors de la récupération des infos de progression:",e),null}}function mt(){const t=Date.now();let e=!1;k.value.forEach((s,o)=>{if(!s.can_attempt&&s.next_attempt_time){const r=new Date(s.next_attempt_time).getTime(),u=Math.max(0,r-t);if(u<=0)k.value.set(o,{can_attempt:!0,message:"Nouvelle tentative autorisée"}),e=!0,console.log(`🎯 Quiz ${o} débloqué automatiquement`);else{const v=Math.floor(u/36e5),d=Math.floor(u%(1e3*60*60)/(1e3*60)),m=`${v}h${d.toString().padStart(2,"0")}min`;s.time_remaining_formatted!==m&&(k.value.set(o,{...s,time_remaining_seconds:Math.floor(u/1e3),time_remaining_formatted:m}),e=!0)}}}),e&&(k.value=new Map(k.value))}function ht(){console.log("🔍 [ChapterQuiz] goBackToChapitres appelé"),console.log("🔍 [ChapterQuiz] chapitreId:",j.params.chapitreId),console.log("🔍 [ChapterQuiz] chapitres.value:",me.value);const t=me.value.find(e=>e.id==j.params.chapitreId);console.log("🔍 [ChapterQuiz] chapitre trouvé:",t),t&&t.notion?(console.log("🔍 [ChapterQuiz] Navigation vers QuizChapitres avec notionId:",t.notion),ye.push({name:"QuizChapitres",params:{notionId:t.notion}})):(console.log("🔍 [ChapterQuiz] Fallback: router.back()"),ye.back())}function Je(t){if(c.value&&!A.value){X();const e="Êtes-vous sûr de vouloir quitter ? Votre progression sera sauvegardée.";return t.returnValue=e,e}}return yt(()=>{ae(),rt(),window.removeEventListener("beforeunload",Je),c.value&&!A.value&&X(),console.log("🎯 Système de cooldown automatique arrêté"),console.log("💾 Sauvegarde automatique désactivée")}),(t,e)=>(a(),bt(Ct,null,{default:qt(()=>[n("section",Dt,[xt(Pt,{text:"Retour aux chapitres",customAction:ht,position:"top-left"}),!c.value&&!A.value?(a(),i("div",Nt,[n("div",Rt,[(a(!0),i(ve,null,pe(Le.value,s=>(a(),i("button",{key:s.key,class:$(["nav-item",{active:s.key===b.value}]),onClick:o=>b.value=s.key},[n("span",Vt,l(s.icon),1),n("span",Xt,l(s.shortLabel),1),n("span",jt,l(s.count),1)],10,Et))),128))])])):Q("",!0),n("div",Jt,[n("h2",Ot,"Quiz QCM - "+l(be.value),1),n("p",Bt,l(Te.value)+" "+l(Te.value>1?"questions":"question")+" disponibles dans "+l(h.value.length)+" "+l((h.value.length>1,"quiz")),1)]),!c.value&&!A.value?(a(),i("div",Ut,[(a(!0),i(ve,null,pe(Ye.value,s=>(a(),i("div",{key:s.id,class:$(["quiz-card",{completed:R(s.id),cooldown:Ve(s.id),"saved-progress":ne(f).value&&ne(f).value.has(s.id)}]),onClick:o=>Qe(s)},[n("div",Ht,[n("h3",Gt,l(s.titre),1),n("span",{class:$(["quiz-difficulty",s.difficulty])},l(Pe(s.difficulty)),3)]),n("p",Kt,l(s.instruction),1),n("div",Wt,[n("span",Yt,l(s.questions?.length||0)+" questions",1),n("span",Zt,"~"+l(ot(s.questions?.length||0)),1)]),Ve(s.id)?(a(),i("div",es,[n("div",ts,[e[1]||(e[1]=n("span",{class:"cooldown-icon"},"⏰",-1)),n("span",ss,l(Ee(s.id).time_remaining_formatted),1)]),n("div",ns,[n("div",os,[e[2]||(e[2]=n("span",{class:"attempts-label"},"Tentative:",-1)),n("span",as,l(Me(s.id)),1)]),n("div",{class:$(["quiz-score",Re(E(s.id))])},[n("span",is,l(E(s.id))+"/10",1)],2)])])):ne(f).value&&ne(f).value.has(s.id)?(a(),i("div",ls,[n("div",us,[e[3]||(e[3]=n("span",{class:"progress-icon"},"🔄",-1)),n("span",rs,[oe(l(x(s.id)?.progress||1)+"/"+l(x(s.id)?.totalQuestions||s.questions?.length||0)+" ",1),x(s.id)?.isJustStarted?(a(),i("span",cs," (Débuté) ")):x(s.id)?.isQuizCompleted?(a(),i("span",ds," (Terminé - Voir résultats) ")):x(s.id)?.questionLost?(a(),i("span",vs,[x(s.id)?.isFirstQuestionLost?(a(),i("span",ps," (Q1 perdue) ")):(a(),i("span",fs," (Q"+l(x(s.id)?.lostQuestion)+" perdue) ",1))])):(a(),i("span",ms," (Q"+l(x(s.id)?.lostQuestion)+" sauvegardée) ",1))])]),n("div",hs,[n("div",gs,[e[4]||(e[4]=n("span",{class:"saved-label"},"Sauvegardé:",-1)),n("span",_s,l(nt(x(s.id)?.lastSaved)),1)]),n("div",{class:$(["quiz-continue-badge",{completed:x(s.id)?.isQuizCompleted}])},[n("span",ws,l(x(s.id)?.isQuizCompleted?"Voir résultats":"Continuer"),1),n("span",zs,l(x(s.id)?.isQuizCompleted?"📊":"→"),1)],2)])])):R(s.id)?(a(),i("div",Qs,[e[6]||(e[6]=n("div",{class:"quiz-left-spacer"},null,-1)),n("div",ys,[n("div",bs,[e[5]||(e[5]=n("span",{class:"attempts-label"},"Tentative:",-1)),n("span",qs,l(Me(s.id)),1)]),n("div",{class:$(["quiz-score",Re(E(s.id))])},[n("span",As,l(E(s.id))+"/10",1)],2)])])):Q("",!0)],10,Ft))),128)),Y.value.length>fe?(a(),i("div",xs,[n("div",Cs," Page "+l(N.value)+" sur "+l(re.value)+" ("+l(Y.value.length)+" quiz au total) ",1),n("div",Ss,[n("button",{onClick:et,disabled:N.value===1,class:"pagination-btn"}," ← Précédent ",8,Is),n("div",ks,[(a(!0),i(ve,null,pe(re.value,s=>(a(),i("button",{key:s,onClick:o=>Ze(s),class:$(["pagination-number",{active:s===N.value}])},l(s),11,Ts))),128))]),n("button",{onClick:tt,disabled:N.value===re.value,class:"pagination-btn"}," Suivant → ",8,$s)])])):Q("",!0),Y.value.length===0?(a(),i("div",Ls,[n("div",Ms,l(b.value==="todo"?"📚":b.value==="continue"?"🔄":b.value==="below-average"?"📈":"🎯"),1),n("h3",null,l(b.value==="todo"?"Aucun quiz à faire":b.value==="continue"?"Aucun quiz en cours":b.value==="below-average"?"Aucun quiz à revoir":"Aucun quiz réussi"),1),n("p",null,l(b.value==="todo"?"Tous les quiz de ce chapitre ont été commencés ou terminés.":b.value==="continue"?"Commencez un quiz pour pouvoir le reprendre plus tard.":b.value==="below-average"?"Bravo ! Aucun quiz n'a une note inférieure à 5/10.":"Terminez des quiz avec une note d'au moins 5/10 pour qu'ils apparaissent ici."),1)])):Q("",!0)])):Q("",!0),c.value&&!A.value?(a(),i("div",Ps,[he.value?(a(),i("div",Ds,[n("div",Ns,[e[12]||(e[12]=n("span",{class:"session-restored-icon"},"🔄",-1)),n("div",Rs,[e[11]||(e[11]=n("strong",null,"Session restaurée",-1)),x(c.value?.id)?.isJustStarted?(a(),i("p",Es,e[7]||(e[7]=[oe(" Vous reprenez là où vous vous étiez arrêté. "),n("strong",{class:"info-text"},"ℹ️ Quiz débuté - Vous commencez à la question 1.",-1)]))):_.value.length===0?(a(),i("p",Vs,e[8]||(e[8]=[oe(" Vous reprenez là où vous vous étiez arrêté. "),n("strong",{class:"warning-text"},"⚠️ La première question a été perdue car vous n'aviez pas encore répondu.",-1),oe(" Vous commencez à la question 2. ")]))):(a(),i("p",Xs,[oe(" Vous reprenez là où vous vous étiez arrêté. "+l(_.value.length)+" réponse(s) précédente(s) sauvegardée(s). ",1),x(c.value?.id)?.questionLost?(a(),i("span",js,e[9]||(e[9]=[n("strong",{class:"warning-text"},"⚠️ La question précédente a été perdue car vous n'aviez pas encore répondu.",-1)]))):(a(),i("span",Js,e[10]||(e[10]=[n("strong",{class:"success-text"},"✅ La question précédente a été sauvegardée avec votre réponse.",-1)])))]))]),n("button",{onClick:e[0]||(e[0]=s=>he.value=!1),class:"session-restored-close"},"✕")])])):Q("",!0),n("div",Os,[n("div",Bs,[n("div",{class:"progress-fill",style:Oe({width:`${(g.value+1)/c.value.questions.length*100}%`})},null,4)]),n("span",Us,l(g.value+1)+" / "+l(c.value.questions.length),1)]),n("div",Fs,[n("div",Hs,[e[13]||(e[13]=n("span",{class:"timer-label"},"Temps par question :",-1)),n("span",{class:$(["timer-time",{warning:P.value<=5,critical:P.value<=2}])},l(P.value)+"s ",3)]),n("div",Gs,[(a(),i("div",{class:"timer-fill-smooth",key:Ce.value,style:Oe({animationDuration:Ge.value,backgroundColor:P.value<=5?P.value<=2?"#ef4444":"#f59e0b":"#10b981",animationPlayState:_e.value?"running":"paused"})},null,4))]),n("div",Ks,[n("span",{class:$(["difficulty-badge",W.value])},l(Pe(W.value))+" - "+l(Ae.value)+"s ",3)])]),n("div",Ws,[n("h3",{class:"question-title",innerHTML:D.value.question},null,8,Ys),n("div",Zs,[(a(!0),i(ve,null,pe(D.value.options,(s,o)=>(a(),i("div",{key:o,class:$(["option-card",{selected:M.value===o,correct:y.value&&o===D.value.correct_answer,incorrect:y.value&&M.value===o&&o!==D.value.correct_answer,disabled:y.value&&P.value<=0}]),onClick:r=>at(o)},[n("div",tn,l(String.fromCharCode(65+o)),1),n("span",{class:"option-text",innerHTML:s},null,8,sn)],10,en))),128))]),y.value&&P.value<=0?(a(),i("div",nn,e[14]||(e[14]=[n("div",{class:"timeout-icon"},"⏰",-1),n("p",{class:"timeout-text"},'Temps écoulé ! La bonne réponse est affichée ci-dessus. Cliquez sur "Question suivante" pour continuer.',-1)]))):Q("",!0),y.value&&D.value.explanation?(a(),i("div",on,[e[15]||(e[15]=n("h4",{class:"explanation-title"},"Explication :",-1)),n("p",{class:"explanation-text",innerHTML:D.value.explanation},null,8,an)])):Q("",!0),n("div",ln,[y.value?Q("",!0):(a(),i("button",{key:0,class:"btn-primary",disabled:M.value===null,onClick:it}," Valider ",8,un)),y.value?(a(),i("div",rn,[g.value<c.value.questions.length-1?(a(),i("button",{key:0,class:"btn-primary",onClick:lt}," Question suivante ")):(a(),i("button",{key:1,class:"btn-success",onClick:De}," Terminer le quiz "))])):Q("",!0)])])])):Q("",!0),A.value?(a(),i("div",cn,[n("div",dn,[e[16]||(e[16]=n("h2",{class:"results-title"},"Résultats du Quiz",-1)),n("div",{class:$(["score-circle",ut($e.value)])},[n("span",vn,l(Math.round($e.value))+"%",1)],2)]),B.value?(a(),i("div",pn,[n("div",{class:$(["xp-earned",{"no-xp":V.value===0}])},[n("div",fn,[V.value>0?(a(),i("span",mn,"🎉")):(a(),i("span",hn,"💡"))]),n("div",gn,[n("div",_n,[V.value>0?(a(),i("span",wn,"+"+l(V.value)+" XP",1)):(a(),i("span",zn,"0 XP"))]),n("div",Qn,[I.value===1&&V.value>0?(a(),i("span",yn,"🥇 Premier essai réussi ! XP = ton score × difficulté")):I.value===1&&V.value===0?(a(),i("span",bn,"💪 Premier essai - Continue à t'améliorer !")):I.value>1?(a(),i("span",qn,"🔄 Tentative supplémentaire - Aucun XP (cooldown 1h30)")):(a(),i("span",An,"Continue tes efforts !"))])])],2),qe.value?(a(),i("div",xn,[e[17]||(e[17]=n("div",{class:"level-up-icon"},"🆙",-1)),n("div",Cn,"Niveau "+l(ne(L).level)+" atteint !",1)])):Q("",!0)])):Q("",!0),n("div",Sn,[n("div",In,[n("span",kn,l(we.value),1),e[18]||(e[18]=n("span",{class:"stat-label"},"Bonnes réponses",-1))]),n("div",Tn,[n("span",$n,l(We.value),1),e[19]||(e[19]=n("span",{class:"stat-label"},"Mauvaises réponses",-1))]),n("div",Ln,[n("span",Mn,l(ze.value),1),e[20]||(e[20]=n("span",{class:"stat-label"},"Total questions",-1))]),ue.value>0?(a(),i("div",Pn,[n("span",Dn,l(ue.value),1),e[21]||(e[21]=n("span",{class:"stat-label"},"Questions perdues",-1))])):Q("",!0),n("div",Nn,[n("span",Rn,l(I.value),1),e[22]||(e[22]=n("span",{class:"stat-label"},"Tentative #",-1))])]),e[25]||(e[25]=n("div",{class:"cooldown-info"},[n("div",{class:"cooldown-info-icon"},"⏰"),n("div",{class:"cooldown-info-text"},[n("strong",null,"Prochaine tentative possible dans 1h30"),n("p",null,"Le système de cooldown empêche la mémorisation des réponses et encourage la préparation.")])],-1)),ue.value>0?(a(),i("div",En,[e[24]||(e[24]=n("div",{class:"lost-questions-info-icon"},"⚠️",-1)),n("div",Vn,[n("strong",null,l(ue.value)+" question(s) perdue(s) pour éviter la tricherie",1),e[23]||(e[23]=n("p",null,"En cas de rafraîchissement ou de perte de connexion, la question en cours est automatiquement perdue pour maintenir l'intégrité du quiz.",-1))])])):Q("",!0),n("div",{class:"results-actions"},[n("button",{class:"btn-primary",onClick:Ne},"Retour à la liste")])])):Q("",!0)])]),_:1}))}},Wn=gt(Xn,[["__scopeId","data-v-96780021"]]);export{Wn as default};
