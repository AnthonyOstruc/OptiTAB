import{c as u,o as l,a as e,_ as j,q as pe,C as ee,M as ne,G as Ae,m as T,p as Z,D as te,b as k,j as q,i as S,u as M,F as U,e as K,f as Y,g as me,t as C,au as Ee,h as N,s as B,n as oe,w as ue,T as ze,k as fe,av as Te,l as P,aw as xe,B as he,ax as Fe,at as Pe,aq as He,ay as Be,az as Oe,aA as Me,d as le,a2 as Re,v as Qe,aB as Ce,Z as Ne,r as Ue}from"./index-C20tTf3S.js";import{m as Ve,b as Ke,c as O,d as R,e as We,f as Q}from"./menuItems-zei-A9he.js";import{a as Se}from"./matieres-Ce1WeeoH.js";function Ze(n,s){return l(),u("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0 3-3m0 0-3-3m3 3H9"})])}function Xe(n,s){return l(),u("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0"})])}function Je(n,s){return l(),u("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z"}),e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"})])}function Ge(n,s){return l(),u("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 0 0 2.25-2.25V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5Z"})])}function Ye(n,s){return l(),u("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M12 18v-5.25m0 0a6.01 6.01 0 0 0 1.5-.189m-1.5.189a6.01 6.01 0 0 1-1.5-.189m3.75 7.478a12.06 12.06 0 0 1-4.5 0m3.75 2.383a14.406 14.406 0 0 1-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 1 0-7.517 0c.85.493 1.509 1.333 1.509 2.316V18"})])}function et(n,s){return l(),u("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"})])}function tt(n,s){return l(),u("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"})])}const st=Ve.filter(n=>["dashboard","cours","calculator","exercices","quiz","fiches"].includes(n.key));function ve(n,s){const d=n?n[0].toUpperCase():"",p=s?s[0].toUpperCase():"";return(d+(p?"."+p:"")).trim()}const at={class:"sidebar-menu"},ot={class:"sidebar-menu-container"},nt=["title"],it={class:"sidebar-icon"},rt={key:0,class:"sidebar-label"},lt=["onClick","title"],ct={class:"sidebar-icon"},dt={key:0,class:"sidebar-label"},ut={key:0,class:"sidebar-section-header"},ht=["title"],vt={class:"sidebar-icon"},pt={key:0,class:"sidebar-label"},mt=["title"],ft={class:"sidebar-icon"},gt={key:0,class:"sidebar-label"},bt=["title"],_t={class:"sidebar-icon"},yt={key:0,class:"sidebar-label"},kt=["title"],$t={class:"sidebar-icon"},wt={key:0,class:"sidebar-label"},xt=["title"],Mt={class:"sidebar-icon"},Ct={key:0,class:"sidebar-label"},St=["title"],It={class:"sidebar-icon"},At={key:0,class:"sidebar-label"},Et=["title"],zt={class:"sidebar-icon"},Tt={key:0,class:"sidebar-label"},Nt={__name:"Sidebar",props:{collapsed:Boolean},emits:["navigation","toggle-collapsed"],setup(n,{expose:s,emit:d}){const p=n,r=d,c=pe(),o=ee(),v=ne(),h=Ae(),f=T(()=>st.filter(x=>x.key!=="dashboard")),b=x=>{const y=v.path,w={dashboard:"/dashboard",cours:["/online-courses","/course-notions","/course-chapitres","/course","/cours"],exercices:["/exercises","/notions","/themes","/theme-notions","/chapitres","/exercices","/chapter-exercises"],fiches:["/sheets"],quiz:["/quiz","/quiz-notions","/quiz-chapitres","/quiz-exercices","/chapter-quiz"],progress:"/progress",calculator:"/calculator"}[x];return w?Array.isArray(w)?w.some(_=>y.startsWith(_)):y===w:!1};async function g(x){if(x.key==="calculator")o.push("/calculator");else if(x.key==="dashboard")o.push("/dashboard");else if(["exercices","fiches","quiz","cours"].includes(x.key)){const y=h.activeMatiereId||h.selectedMatieresIds?.[0]||null;x.key==="exercices"?y?o.push({name:"Themes",params:{matiereId:String(y)}}):o.push({name:"Exercises"}):x.key==="fiches"?y?o.push({name:"Sheets",query:{matiereId:String(y)}}):o.push({name:"Sheets"}):x.key==="quiz"?y?o.push({name:"QuizNotions",params:{matiereId:String(y)}}):o.push({name:"Quiz"}):x.key==="cours"&&(y?o.push({name:"CourseNotions",params:{matiereId:String(y)}}):o.push({name:"OnlineCourses"}))}}T(()=>(c.firstName+" "+c.lastName).trim()),T(()=>ve(c.firstName,c.lastName)),c.firstName+""+c.lastName,ve(c.firstName,c.lastName);let E=null,L=null;const z=()=>window.innerWidth<1024,D=()=>{E&&clearTimeout(E),E=setTimeout(()=>{(z()&&!p.collapsed||!z()&&p.collapsed)&&r("toggle-collapsed")},30)};return Z(()=>{z()&&!p.collapsed&&setTimeout(()=>{r("toggle-collapsed")},10),window.addEventListener("resize",D),window.ResizeObserver&&(L=new ResizeObserver(()=>{D()}),L.observe(document.body))}),te(()=>{window.removeEventListener("resize",D),E&&clearTimeout(E),L&&L.disconnect()}),s({isActiveRoute:b,handleSidebarClick:g,handleLogout:async()=>{const x=localStorage.getItem("refresh_token");if(x&&x!=="null"&&x!=="undefined"&&x.trim()!=="")try{await Ee({refresh:x})}catch{}localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),c.clearUser(),o.push("/")}}),(x,y)=>(l(),u("aside",{class:q(["sidebar",{collapsed:n.collapsed}])},[e("nav",at,[e("div",ot,[e("ul",null,[e("li",{class:q(["sidebar-item",{active:b("dashboard")}]),onClick:y[0]||(y[0]=m=>g({key:"dashboard"})),title:n.collapsed?"Tableau de bord":""},[e("span",it,[S(M(Ke))]),n.collapsed?k("",!0):(l(),u("span",rt,"Tableau de bord"))],10,nt),(l(!0),u(U,null,K(f.value,m=>(l(),u("li",{class:q(["sidebar-item",{active:b(m.key)}]),key:m.key,onClick:w=>g(m),title:n.collapsed?m.text:""},[e("span",ct,[(l(),Y(me(m.icon)))]),n.collapsed?k("",!0):(l(),u("span",dt,C(m.text),1))],10,lt))),128)),M(c).isAdmin?(l(),u(U,{key:0},[n.collapsed?k("",!0):(l(),u("li",ut,y[8]||(y[8]=[e("span",{class:"section-title"},"⚙️ Administration",-1)]))),e("li",{class:"sidebar-item",onClick:y[1]||(y[1]=m=>M(o).push("/admin/matieres")),title:n.collapsed?"Matières":""},[e("span",vt,[S(M(O),{class:"h-6 w-6"})]),n.collapsed?k("",!0):(l(),u("span",pt,"Matières"))],8,ht),e("li",{class:"sidebar-item",onClick:y[2]||(y[2]=m=>M(o).push("/admin/notions")),title:n.collapsed?"Notions":""},[e("span",ft,[S(M(Ye),{class:"h-6 w-6"})]),n.collapsed?k("",!0):(l(),u("span",gt,"Notions"))],8,mt),e("li",{class:"sidebar-item",onClick:y[3]||(y[3]=m=>M(o).push("/admin/chapitres")),title:n.collapsed?"Chapitres":""},[e("span",_t,[S(M(R),{class:"h-6 w-6"})]),n.collapsed?k("",!0):(l(),u("span",yt,"Chapitres"))],8,bt),e("li",{class:"sidebar-item",onClick:y[4]||(y[4]=m=>M(o).push("/admin/exercices")),title:n.collapsed?"Exercices":""},[e("span",$t,[S(M(et),{class:"h-6 w-6"})]),n.collapsed?k("",!0):(l(),u("span",wt,"Exercices"))],8,kt),e("li",{class:"sidebar-item",onClick:y[5]||(y[5]=m=>M(o).push("/admin/exercices-plus")),title:n.collapsed?"Exercices+":""},[e("span",Mt,[S(M(tt))]),n.collapsed?k("",!0):(l(),u("span",Ct,"Exercices+"))],8,xt),e("li",{class:"sidebar-item",onClick:y[6]||(y[6]=m=>M(o).push("/admin/fiches")),title:n.collapsed?"Fiches":""},[e("span",It,[S(M(We),{class:"h-6 w-6"})]),n.collapsed?k("",!0):(l(),u("span",At,"Fiches"))],8,St),e("li",{class:"sidebar-item",onClick:y[7]||(y[7]=m=>M(o).push("/admin/quiz")),title:n.collapsed?"Quiz":""},[e("span",zt,[S(M(Q),{class:"h-6 w-6"})]),n.collapsed?k("",!0):(l(),u("span",Tt,"Quiz"))],8,Et)],64)):k("",!0)])])])],2))}},Lt=j(Nt,[["__scopeId","data-v-f86d1804"]]),qt=["aria-expanded"],Dt={class:"user-info"},jt=["aria-label"],Ft={class:"user-avatar"},Pt={class:"user-details"},Ht={class:"user-name"},Bt={class:"user-title"},Ot={key:0,class:"user-xp-bar"},Rt={key:0,class:"user-menu-dropdown"},Qt={class:"menu-avatar"},Ut={class:"menu-user-info"},Vt={class:"menu-full-name"},Kt={class:"menu-email"},Wt={class:"menu-options"},Zt={class:"option-icon"},Xt={class:"option-icon"},Jt={class:"option-icon"},Gt={__name:"UserMenu",emits:["logout"],setup(n,{emit:s}){const d=s,p=pe(),r=ee(),c=N(!1),o=N(null),v=T(()=>`${p.firstName} ${p.lastName}`.trim()||"Utilisateur"),h=T(()=>ve(p.firstName,p.lastName)),f=T(()=>{if(!p.isAuthenticated)return"";const _=p.level??0,I=p.xp??0;return`Niveau ${_} · ${I} XP`}),b=T(()=>p.isAuthenticated),g=T(()=>{const _=Number(p.level||0),I=Number(p.xp||0),H=_*_*10,W=(_+1)*(_+1)*10,se=Math.max(I,H)-H,ie=Math.max(1,W-H);return Math.min(100,Math.round(se/ie*100))}),E=T(()=>p.email||"email@exemple.com"),L=()=>{c.value=!c.value},z=()=>{c.value=!1},D=()=>{z(),r.push("/account")},F=()=>{z(),r.push("/pricing")},x=()=>{z(),r.push("/account")},y=async()=>{z();try{const _=localStorage.getItem("refresh_token");if(_&&_!=="null"&&_!=="undefined"&&_.trim()!=="")try{await Ee({refresh:_})}catch(I){console.log("Erreur lors de la déconnexion backend:",I.message)}localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),p.clearUser(),d("logout"),r.push("/")}catch(_){console.error("Erreur lors de la déconnexion:",_),localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),p.clearUser(),r.push("/")}},m=_=>{o.value&&!o.value.contains(_.target)&&z()},w=_=>{_.key==="Escape"&&c.value&&z()};return B(()=>[p.xp,p.level,p.xp_to_next],(_,I)=>{console.log("🏪 UserMenu - Changement détecté dans le store:",{old:{xp:I[0],level:I[1],xp_to_next:I[2]},new:{xp:_[0],level:_[1],xp_to_next:_[2]},progress:g.value})},{deep:!0}),Z(()=>{document.addEventListener("click",m),document.addEventListener("keydown",w)}),te(()=>{document.removeEventListener("click",m),document.removeEventListener("keydown",w)}),(_,I)=>(l(),u("div",{class:"user-menu-container",ref_key:"menuContainer",ref:o},[e("button",{class:"user-menu-trigger",onClick:L,"aria-expanded":c.value,"aria-label":"Menu utilisateur"},[e("div",Dt,[e("div",{class:"avatar-progress",style:oe({"--progress":g.value+"%"}),role:"img","aria-label":`Progression de niveau: ${g.value}%`,title:"Progression vers le prochain niveau"},[e("span",Ft,C(h.value),1)],12,jt),e("div",Pt,[e("span",Ht,C(v.value),1),e("span",Bt,C(f.value),1),b.value?(l(),u("div",Ot,[e("div",{class:"user-xp-fill",style:oe({width:g.value+"%"})},null,4)])):k("",!0)])])],8,qt),S(ze,{name:"menu-dropdown"},{default:ue(()=>[c.value?(l(),u("div",Rt,[e("button",{class:"menu-header",onClick:x},[e("span",Qt,C(h.value),1),e("div",Ut,[e("div",Vt,C(v.value),1),e("div",Kt,C(E.value),1)])]),e("div",Wt,[e("button",{class:"menu-option",onClick:D},[e("span",Zt,[S(M(Je),{class:"user-menu-heroicon"})]),I[0]||(I[0]=e("span",{class:"option-label"},"Mon compte",-1))]),e("button",{class:"menu-option",onClick:F},[e("span",Xt,[S(M(Ge),{class:"user-menu-heroicon"})]),I[1]||(I[1]=e("span",{class:"option-label"},"Abonnement",-1))]),e("button",{class:"menu-option logout-option",onClick:y},[e("span",Jt,[S(M(Ze),{class:"user-menu-heroicon"})]),I[2]||(I[2]=e("span",{class:"option-label"},"Déconnexion",-1))])])])):k("",!0)]),_:1})],512))}},Yt=j(Gt,[["__scopeId","data-v-1c6e40ed"]]),es={class:"subject-filters"},ts=["onClick"],ss={__name:"SubjectFilters",props:{subjects:{type:Array,default:()=>[{id:"maths",name:"Mathématiques"},{id:"physics",name:"Physique"},{id:"chemistry",name:"Chimie"}]},initialSubject:{type:String,default:"maths"}},emits:["subject-changed"],setup(n,{expose:s,emit:d}){const p=n,r=d,c=N(p.initialSubject),o=v=>{c.value=v,r("subject-changed",v)};return B(()=>p.initialSubject,v=>{c.value=v}),s({selectedSubject:c}),(v,h)=>(l(),u("div",es,[(l(!0),u(U,null,K(n.subjects,f=>(l(),u("button",{key:f.id,class:q(["subject-btn",{active:c.value===f.id}]),onClick:b=>o(f.id)},C(f.name),11,ts))),128))]))}},as=j(ss,[["__scopeId","data-v-15ed2311"]]),os={class:"chapter-navigation","aria-label":"Navigation des chapitres"},ns=["aria-pressed","aria-label","onClick"],is={class:"chapter-nav-label"},rs={__name:"ChapterNavigation",props:{chapitreId:{type:[String,Number],required:!1,default:null}},setup(n){const s=n,d=ne(),p=ee(),r=T(()=>{const h=d.path,f=d.params.notionId,b=s.chapitreId||d.params.chapitreId,g=d.params.matiereId;return b&&b!==null?[{key:"cours",label:"Cours",icon:R,route:`/course/${b}`},{key:"exercices",label:"Exercices",icon:O,route:`/exercices/${b}`},{key:"quiz",label:"Quiz",icon:Q,route:`/quiz-exercices/${b}`}]:f&&h.includes("/chapitres/")&&!h.includes("/quiz-chapitres/")&&!h.includes("/course-chapitres/")?[{key:"cours",label:"Cours",icon:R,route:`/course-chapitres/${f}`},{key:"exercices",label:"Exercices",icon:O,route:`/chapitres/${f}`},{key:"quiz",label:"Quiz",icon:Q,route:`/quiz-chapitres/${f}`}]:g&&h.includes("/notions/")?[{key:"cours",label:"Cours",icon:R,route:`/course-notions/${g}`},{key:"exercices",label:"Exercices",icon:O,route:`/notions/${g}`},{key:"quiz",label:"Quiz",icon:Q,route:`/quiz/${g}`}]:f&&h.includes("/course-chapitres/")?[{key:"cours",label:"Cours",icon:R,route:`/course-chapitres/${f}`},{key:"exercices",label:"Exercices",icon:O,route:`/chapitres/${f}`},{key:"quiz",label:"Quiz",icon:Q,route:`/quiz-chapitres/${f}`}]:f&&h.includes("/quiz-chapitres/")?[{key:"cours",label:"Cours",icon:R,route:`/course-chapitres/${f}`},{key:"exercices",label:"Exercices ",icon:O,route:`/chapitres/${f}`},{key:"quiz",label:"Quiz",icon:Q,route:`/quiz-chapitres/${f}`}]:g&&h.includes("/course-notions/")?[{key:"cours",label:"Cours",icon:R,route:`/course-notions/${g}`},{key:"exercices",label:"Exercices",icon:O,route:`/notions/${g}`},{key:"quiz",label:"Quiz",icon:Q,route:`/quiz/${g}`}]:g&&h.includes("/quiz/")?[{key:"cours",label:"Cours",icon:R,route:`/course-notions/${g}`},{key:"exercices",label:"Exercices ",icon:O,route:`/notions/${g}`},{key:"quiz",label:"Quiz",icon:Q,route:`/quiz/${g}`}]:[{key:"cours",label:"Cours",icon:R,route:"/online-courses"},{key:"exercices",label:"Exercices",icon:O,route:"/exercises"},{key:"quiz",label:"Quiz",icon:Q,route:"/quiz"}]}),c=N("exercices");function o(){const h=d.path,f=s.chapitreId||d.params.chapitreId;f&&f!==null?h.includes(`/course/${f}`)?c.value="cours":h.includes(`/exercices/${f}`)?c.value="exercices":h.includes(`/quiz-exercices/${f}`)?c.value="quiz":c.value="exercices":h.includes("/course/")||h.includes("/course-chapitres/")||h.includes("/course-notions/")?c.value="cours":h.includes("/exercices/")||h.includes("/chapitres/")&&!h.includes("/quiz-chapitres/")&&!h.includes("/course-chapitres/")||h.includes("/notions/")?c.value="exercices":h.includes("/quiz-exercices/")||h.includes("/quiz-chapitres/")||h.includes("/quiz/")&&d.params.matiereId?c.value="quiz":c.value="exercices"}Z(()=>{o()}),B(()=>d.path,()=>{o()});function v(h){const f=r.value.find(b=>b.key===h);f&&(c.value=h,p.push({path:f.route,replace:!1}).catch(b=>{console.warn("Navigation error:",b),o()}))}return(h,f)=>(l(),u("nav",os,[(l(!0),u(U,null,K(r.value,b=>(l(),u("button",{key:b.key,class:q(["chapter-nav-btn",{active:b.key===c.value}]),"aria-pressed":b.key===c.value,"aria-label":b.label,onClick:g=>v(b.key)},[(l(),Y(me(b.icon),{class:"chapter-nav-icon"})),e("span",is,C(b.label),1)],10,ns))),128))]))}},ls=j(rs,[["__scopeId","data-v-e4438b84"]]),cs={class:"context-menu-icon"},ds={class:"context-menu-text"},us={__name:"ContextMenu",props:{visible:{type:Boolean,default:!1},x:{type:Number,default:0},y:{type:Number,default:0},isFavorite:{type:Boolean,default:!1},matiereId:{type:[Number,String,null],default:null}},emits:["favorite-toggle","close"],setup(n,{emit:s}){const d=n,p=s,r=T(()=>({position:"fixed",left:`${d.x}px`,top:`${d.y}px`,zIndex:12006}));function c(){d.matiereId!==null&&p("favorite-toggle",d.matiereId),p("close")}function o(h){d.visible&&p("close")}function v(h){h.key==="Escape"&&d.visible&&p("close")}return Z(()=>{document.addEventListener("click",o),document.addEventListener("keydown",v)}),te(()=>{document.removeEventListener("click",o),document.removeEventListener("keydown",v)}),(h,f)=>fe((l(),u("div",{class:"context-menu",style:oe(r.value),onClick:f[0]||(f[0]=P(()=>{},["stop"]))},[e("div",{class:"context-menu-item",onClick:c},[e("span",cs,C(n.isFavorite?"⭐":"☆"),1),e("span",ds,C(n.isFavorite?"Retirer des favoris":"Ajouter aux favoris"),1)])],4)),[[Te,n.visible]])}},hs=j(us,[["__scopeId","data-v-6f3586a5"]]),vs={class:"selected-matiere-header"},ps={key:0,class:"loading-state"},ms={key:1,class:"matieres-tabs"},fs={class:"tabs-container"},gs=["disabled"],bs=["onClick","onMousedown","onContextmenu","title","aria-label","aria-selected"],_s={class:"tab-name"},ys=["onClick","title","aria-label","disabled"],ks=["disabled"],$s=["onClick","onContextmenu","title"],ws={class:"dropdown-content-left"},xs=["innerHTML"],Ms={class:"dropdown-name"},Cs=["onClick","title","aria-label","disabled"],Ss={class:"star-icon"},Is={key:0,class:"dropdown-empty"},As={key:0,class:"favorites-bar"},Es={class:"favorites-container"},zs={class:"favorites-list"},Ts=["onClick","onContextmenu","title","aria-label","disabled"],Ns=["innerHTML"],Ls={class:"favorite-name"},qs=["title","aria-label"],ce=5,Ie=6,de="matieres_disponibles_cache",Ds=600*1e3,js={__name:"SelectedMatiereHeader",props:{matiereId:{type:[Number,String],default:null,validator:n=>n===null||!isNaN(Number(n))&&Number(n)>0}},emits:["matiere-changed"],setup(n,{emit:s}){const d=n;B(()=>d.matiereId,t=>{o.value.matiereId=t||null});const p=s;ee();const r=Ae(),c=pe(),o=N({visible:!1,x:0,y:0,matiereId:d.matiereId||null,isFavorite:!1}),v=N([]),h=N(!1),f=N(null),b=N(null),g=N(null),E=N(!1),L=N(!1),z=N(null),D=N({}),F=T(()=>v.value.filter(t=>t&&t.id&&r.selectedMatieresIds.includes(t.id))),x=T(()=>v.value.filter(t=>t&&t.id&&!r.selectedMatieresIds.includes(t.id))),y=T(()=>{const t=v.value.filter(a=>a&&a.id&&r.isFavoriteMatiere(a.id));return!L.value&&t.length>ce?t.slice(0,ce):t});T(()=>v.value.find(t=>t&&t.id===g.value));const m=(t,a)=>{console.error(`[SelectedMatiereHeader] Erreur dans ${a}:`,t)},w=t=>t!=null&&!isNaN(Number(t))&&Number(t)>0,_=()=>{try{const t=localStorage.getItem(de);if(!t)return null;const a=JSON.parse(t);return!a||!Array.isArray(a.data)?null:a}catch{return null}},I=t=>{try{const a={niveauId:c.niveau_pays?.id||null,ts:Date.now(),data:t};localStorage.setItem(de,JSON.stringify(a))}catch{}},H=()=>{try{localStorage.removeItem(de)}catch{}},W=async()=>{try{if(!c.niveau_pays?.id)return;const t=await Se();if(t&&t.data&&t.data.matieres_disponibles){const a=t.data.matieres_disponibles.filter(A=>A&&A.id&&A.nom),i=(v.value||[]).map(A=>A.id).join(","),$=a.map(A=>A.id).join(",");i!==$&&(v.value=a),I(a)}}catch{}},V=async({useCache:t=!0}={})=>{if(!h.value){if(t){const a=_(),i=a?.niveauId===(c.niveau_pays?.id||null),$=a&&Date.now()-a.ts<Ds;if(a&&i&&$){v.value=a.data.filter(A=>A&&A.id&&A.nom),W();return}}h.value=!0;try{if(!c.niveau_pays?.id){v.value=[];return}const a=await Se();if(a&&a.data&&a.data.matieres_disponibles){const i=a.data.matieres_disponibles.filter($=>$&&$.id&&$.nom);v.value=i,I(i),console.log("[SelectedMatiereHeader] Matières chargées pour utilisateur:",i.length)}else throw new Error("Format de réponse API invalide")}catch(a){m(a,"loadMatieres"),v.value=[]}finally{h.value=!1}}},se=async t=>{if(!(!w(t)||h.value))try{if(E.value&&X(),r.removeMatiereId(t),console.log("[SelectedMatiereHeader] Matière retirée:",t),g.value===t){const a=F.value.filter(i=>i.id!==t);a.length>0?(await he(),G(a[0].id)):(g.value=null,p("matiere-changed",null))}}catch(a){m(a,"removeMatiere")}},ie=(t,a)=>{if(t.button===1){t.preventDefault(),t.stopPropagation(),se(a);return}},G=t=>{if(!(!w(t)||h.value||f.value===t))try{g.value=t,r.setActiveMatiere(t),p("matiere-changed",t),console.log("[SelectedMatiereHeader] Matière active changée:",t)}catch(a){m(a,"setActiveMatiere")}},ge=(t=null)=>{const a=t||z.value;if(!a||typeof a.getBoundingClientRect!="function")return{};try{const i=a.getBoundingClientRect(),$=window.innerHeight,A=window.innerWidth;let J={position:"fixed",top:`${i.bottom+Ie}px`,left:`${i.left}px`,minWidth:`${Math.max(i.width,280)}px`,maxWidth:`${Math.min(400,A-20)}px`,zIndex:12005};return i.bottom+300>$&&(J.top=`${i.top-300-Ie}px`,J.bottom="auto"),i.left+280>A&&(J.left=`${A-300}px`),J}catch(i){return m(i,"calculateDropdownPosition"),{}}},be=async t=>{if(!h.value)try{if(E.value=!E.value,E.value){await he();const a=t&&t.currentTarget||z.value||null;D.value=ge(a)}else D.value={}}catch(a){m(a,"toggleMatiereDropdown")}},X=()=>{E.value=!1,D.value={}},_e=async t=>{if(!(!t?.id||h.value||f.value===t.id)){f.value=t.id;try{r.selectedMatieresIds.includes(t.id)||r.addMatiereId(t.id),g.value=t.id,r.setActiveMatiere(t.id),p("matiere-changed",t.id),E.value&&X(),console.log("[SelectedMatiereHeader] Matière sélectionnée et activée:",t.nom)}catch(a){m(a,"selectMatiere")}finally{f.value=null}}},re=(t,a)=>{t.preventDefault(),o.value={visible:!0,x:t.clientX,y:t.clientY,matiereId:a.id,isFavorite:r.isFavoriteMatiere(a.id)}},Le=()=>{o.value.visible=!1},qe=async t=>{await ye(t)},ye=async t=>{if(!(!w(t)||b.value===t)){b.value=t;try{r.toggleFavoriteMatiere(t);const a=v.value.find($=>$.id===t),i=r.isFavoriteMatiere(t);console.log(`[SelectedMatiereHeader] ${a?.nom||t} ${i?"ajouté aux":"retiré des"} favoris`)}catch(a){m(a,"toggleFavorite")}finally{b.value=null}}},De=()=>{L.value=!L.value},ke=t=>{if(E.value)try{const a=document.querySelector(".matiere-dropdown"),i=z.value,$=a&&a.contains(t.target),A=i&&i.contains(t.target),J=t.target.classList&&t.target.classList.contains("tab-close");(!$&&!A||J)&&X()}catch(a){m(a,"handleClickOutside")}},$e=t=>{try{t.key==="Escape"&&E.value&&(t.preventDefault(),X())}catch(a){m(a,"handleKeydown")}},je=t=>{try{const a=document.querySelectorAll(".dropdown-item:not(:disabled)"),i=Array.from(a).findIndex($=>$===document.activeElement);switch(t.key){case"ArrowDown":t.preventDefault();const $=i<a.length-1?i+1:0;a[$]?.focus();break;case"ArrowUp":t.preventDefault();const A=i>0?i-1:a.length-1;a[A]?.focus();break;case"Enter":case" ":t.preventDefault(),document.activeElement.classList.contains("dropdown-item")&&document.activeElement.click();break;case"Escape":t.preventDefault(),X(),z.value?.focus();break}}catch(a){m(a,"handleDropdownKeydown")}};Z(async()=>{try{await Promise.all([V({useCache:!0}),r.loadSelectedMatieresIds(),r.loadFavoriteMatieresIds(),r.loadActiveMatiereId()]),v.value.length>0&&r.selectedMatieresIds.length===0&&(r.addMatiereId(v.value[0].id),G(v.value[0].id)),r.activeMatiereId&&(g.value=r.activeMatiereId),document.addEventListener("click",ke,{passive:!0}),document.addEventListener("keydown",$e,{passive:!0}),ae=()=>{E.value&&(D.value=ge(z.value||null))},window.addEventListener("resize",ae,{passive:!0});const t=()=>{H(),V({useCache:!1})};window.addEventListener("matieres-cache:invalidate",t),we.push(t)}catch(t){m(t,"onMounted")}});const we=[];let ae=null;return te(()=>{try{document.removeEventListener("click",ke),document.removeEventListener("keydown",$e),ae&&window.removeEventListener("resize",ae);for(const t of we)window.removeEventListener("matieres-cache:invalidate",t);console.log("[SelectedMatiereHeader] Composant détruit - nettoyage effectué")}catch(t){m(t,"onUnmounted")}}),B(()=>d.matiereId,async t=>{if(w(t))try{console.log("[SelectedMatiereHeader] ID de matière changé:",t),v.value.length===0&&await V(),r.selectedMatieresIds.includes(Number(t))||r.addMatiereId(t),g.value||G(Number(t))}catch(a){m(a,"watch matiereId")}},{immediate:!0}),B(()=>F.value,(t,a)=>{try{if(console.log("[SelectedMatiereHeader] Changement dans les matières sélectionnées:",{nouvelles:t.map(i=>i.id),anciennes:a?.map(i=>i.id)||[],matiereActive:g.value}),!g.value&&t.length>0){const i=r.activeMatiereId;i&&t.find($=>$.id===i)&&(g.value=i)}}catch(i){m(i,"watch selectedMatieres")}}),B(()=>c.niveau_pays,async t=>{if(t)try{console.log("[SelectedMatiereHeader] Niveau changé, rechargement des matières:",t.nom),await V();const a=v.value.map(i=>i.id);r.selectedMatieresIds=r.selectedMatieresIds.filter(i=>a.includes(i)),r.selectedMatieresIds.length===0&&v.value.length>0&&(r.addMatiereId(v.value[0].id),G(v.value[0].id))}catch(a){m(a,"watch userStore.niveau_pays")}},{immediate:!1}),B(()=>r.activeMatiereId,t=>{try{console.log("[SelectedMatiereHeader] Matière active changée dans le store:",t),t!==g.value&&(t&&F.value.find(a=>a.id===t)?(g.value=t,p("matiere-changed",t),console.log("[SelectedMatiereHeader] État local synchronisé avec le store:",t)):t&&!r.selectedMatieresIds.includes(t)&&(r.addMatiereId(t),console.log("[SelectedMatiereHeader] Matière ajoutée automatiquement aux sélectionnées:",t)))}catch(a){m(a,"watch store activeMatiereId")}},{immediate:!1}),(t,a)=>(l(),u("div",vs,[(l(),Y(xe,{to:"body"},[S(hs,{visible:o.value.visible,x:o.value.x,y:o.value.y,"is-favorite":o.value.isFavorite,"matiere-id":o.value.matiereId,onFavoriteToggle:qe,onClose:Le},null,8,["visible","x","y","is-favorite","matiere-id"])])),h.value&&v.value.length===0?(l(),u("div",ps,a[2]||(a[2]=[e("div",{class:"loading-spinner"},null,-1),e("span",null,"Chargement des matières...",-1)]))):(l(),u("div",ms,[e("div",fs,[F.value.length===0?(l(),u("button",{key:0,class:"matiere-tab new-tab",onClick:a[0]||(a[0]=i=>be(i)),disabled:h.value,title:"Ajouter une nouvelle matière",ref_key:"newMatiereButton",ref:z,"aria-label":"Ajouter une nouvelle matière"},a[3]||(a[3]=[e("span",{class:"tab-icon","aria-hidden":"true"},"+",-1),e("span",{class:"tab-name"},"New Matière",-1)]),8,gs)):k("",!0),(l(!0),u(U,null,K(F.value,i=>(l(),u("div",{key:`tab-${i.id}`,class:q(["matiere-tab",{active:g.value===i.id,loading:f.value===i.id}]),onClick:$=>G(i.id),onMousedown:$=>ie($,i.id),onContextmenu:P($=>re($,i),["prevent"]),title:`Voir ${i.nom}`,"aria-label":`Matière ${i.nom}`,"aria-selected":g.value===i.id,role:"tab"},[e("span",_s,C(i.nom),1),e("button",{class:"tab-close",onClick:P($=>se(i.id),["stop"]),title:`Fermer ${i.nom}`,"aria-label":`Fermer l'onglet ${i.nom}`,disabled:h.value}," × ",8,ys)],42,bs))),128)),F.value.length>0?(l(),u("button",{key:1,class:"matiere-tab new-tab-small",onClick:a[1]||(a[1]=i=>be(i)),disabled:h.value||x.value.length===0,title:"Ajouter une nouvelle matière",ref_key:"newMatiereButton",ref:z,"aria-label":"Ajouter une nouvelle matière"},a[4]||(a[4]=[e("span",{class:"tab-icon","aria-hidden":"true"},"+",-1)]),8,ks)):k("",!0)]),(l(),Y(xe,{to:"body"},[E.value?(l(),u("div",{key:0,class:"matiere-dropdown",style:oe(D.value),role:"listbox","aria-label":"Liste des matières disponibles",onKeydown:je},[e("div",{class:"dropdown-header"},[a[5]||(a[5]=e("span",{class:"dropdown-title"},"Matières disponibles",-1)),e("button",{class:"dropdown-close",onClick:X,"aria-label":"Fermer la liste"}," × ")]),(l(!0),u(U,null,K(x.value,(i,$)=>(l(),u("div",{key:`dropdown-${i.id}`,class:q(["dropdown-item",{"last-item":$===x.value.length-1,loading:f.value===i.id}]),onClick:A=>_e(i),onContextmenu:P(A=>re(A,i),["prevent"]),role:"option","aria-selected":!1,title:`Ouvrir ${i.nom}`},[e("div",ws,[e("span",{class:"dropdown-icon",innerHTML:i.svg_icon||"📚","aria-hidden":"true"},null,8,xs),e("span",Ms,C(i.nom),1)]),e("button",{class:q(["dropdown-star",{favorite:M(r).isFavoriteMatiere(i.id),loading:b.value===i.id}]),onClick:P(A=>ye(i.id),["stop"]),title:M(r).isFavoriteMatiere(i.id)?"Retirer des favoris":"Ajouter aux favoris","aria-label":M(r).isFavoriteMatiere(i.id)?`Retirer ${i.nom} des favoris`:`Ajouter ${i.nom} aux favoris`,disabled:b.value===i.id},[e("span",Ss,C(M(r).isFavoriteMatiere(i.id)?"⭐":"☆"),1)],10,Cs)],42,$s))),128)),x.value.length===0?(l(),u("div",Is,a[6]||(a[6]=[e("span",{class:"empty-icon"},"📚",-1),e("span",{class:"empty-text"},"Toutes les matières sont déjà ouvertes",-1)]))):k("",!0)],36)):k("",!0)])),y.value.length>0?(l(),u("div",As,[e("div",Es,[a[7]||(a[7]=e("div",{class:"favorites-label"},[e("span",{class:"favorites-icon","aria-hidden":"true"},"⭐"),e("span",{class:"favorites-text"},"Favoris:")],-1)),e("div",zs,[(l(!0),u(U,null,K(y.value,i=>(l(),u("button",{key:`favorite-${i.id}`,class:q(["favorite-item",{active:g.value===i.id,loading:f.value===i.id}]),onClick:$=>_e(i),onContextmenu:P($=>re($,i),["prevent"]),title:`Ouvrir ${i.nom}`,"aria-label":`Ouvrir la matière favorite ${i.nom}`,disabled:f.value===i.id},[e("span",{class:"favorite-icon",innerHTML:i.svg_icon||"📚","aria-hidden":"true"},null,8,Ns),e("span",Ls,C(i.nom),1)],42,Ts))),128))]),y.value.length>ce?(l(),u("button",{key:0,class:"favorites-toggle",onClick:De,title:L.value?"Réduire les favoris":"Voir tous les favoris","aria-label":L.value?"Réduire la liste des favoris":"Voir tous les favoris"},C(L.value?"‹":"›"),9,qs)):k("",!0)])])):k("",!0)]))]))}},Fs=j(js,[["__scopeId","data-v-ac06c28c"]]),Ps={class:"header-center"},Hs={__name:"ConditionalHeader",props:{subjectPages:{type:Array,default:()=>["Calculator","Exercises","Sheets"]},searchPages:{type:Array,default:()=>["Dashboard","Chapitres","Notions"]},chapterPages:{type:Array,default:()=>["Exercices","ChapterQuiz","CourseChapitre","QuizChapitres","CourseChapitres","Chapitres"]},matierePages:{type:Array,default:()=>["Dashboard","Themes","Notions","Exercises","OnlineCourses","CourseNotions","Quiz","QuizNotions","Sheets"]},subjectProps:{type:Object,default:()=>({})},searchProps:{type:Object,default:()=>({})},chapterProps:{type:Object,default:()=>({})},matiereProps:{type:Object,default:()=>({})}},emits:["subject-changed","search"],setup(n,{emit:s}){const d=n,p=s,r=ne(),c=T(()=>{const h=r.name;return h==="Quiz"||h==="QuizNotions"||h==="Dashboard"||d.matierePages.includes(h)?Fs:d.chapterPages.includes(h)?ls:d.subjectPages.includes(h)?as:null}),o=T(()=>{const h=r.name;return h==="Quiz"||h==="QuizNotions"||h==="Dashboard"||d.matierePages.includes(h)?{matiereId:d.matiereProps.matiereId,...d.matiereProps}:d.chapterPages.includes(h)?{chapitreId:r.params.chapitreId,...d.chapterProps}:d.subjectPages.includes(h)?{...d.subjectProps}:{...d.searchProps}}),v=h=>{p("subject-changed",h)};return(h,f)=>(l(),u("div",Ps,[(l(),Y(me(c.value),Fe(o.value,{onSubjectChanged:v}),null,16))]))}},Bs=j(Hs,[["__scopeId","data-v-887afde6"]]),Os={class:"notification-center"},Rs={key:0,class:"notification-badge"},Qs={class:"notification-header"},Us={class:"notification-actions"},Vs={class:"notification-list"},Ks=["onClick"],Ws={class:"notification-item-icon"},Zs={class:"icon"},Xs={class:"notification-item-content"},Js={class:"notification-item-title"},Gs={class:"notification-item-message"},Ys={class:"notification-item-time"},ea={key:0,class:"unread-indicator"},ta=["onClick"],sa={key:0,class:"notification-empty"},aa={__name:"NotificationCenter",setup(n){const s=Pe(),d=N(!1),p=T(()=>s.notifications),r=T(()=>s.unreadCount),c=T(()=>s.hasUnread);function o(){d.value=!d.value}function v(){d.value=!1}const{markAsRead:h,markAllAsRead:f,removeNotification:b,clearAll:g,loadFromServer:E}=s;async function L(m){if(!m.read)try{await h(m.id)}catch(w){console.warn("⚠️ Erreur lors du marquage de la notification:",w)}m.type}async function z(m){b(m);try{await Oe(m)}catch{}}async function D(){g();try{await Be()}catch{}}function F(m){return{xp_gained:"⭐",level_up:"🏆",exercise_unlocked:"🔓",chapter_completed:"✅",achievement:"🏅",daily_streak:"🔥"}[m]||"🔔"}function x(m){const w=new Date,_=new Date(m),I=w-_,H=Math.floor(I/(1e3*60)),W=Math.floor(H/60),V=Math.floor(W/24);return H<1?"À l'instant":H<60?`Il y a ${H}min`:W<24?`Il y a ${W}h`:V<7?`Il y a ${V}j`:_.toLocaleDateString("fr-FR",{day:"numeric",month:"short"})}function y(m){m.key==="Escape"&&d.value&&v()}return Z(()=>{document.addEventListener("keydown",y);try{E()}catch{}}),te(()=>{document.removeEventListener("keydown",y)}),(m,w)=>(l(),u("div",Os,[e("button",{class:q(["notification-trigger",{"has-notifications":c.value}]),onClick:o,"aria-label":"Notifications",title:"Notifications"},[S(M(Xe),{class:"notification-icon"}),r.value>0?(l(),u("span",Rs,C(r.value>99?"99+":r.value),1)):k("",!0)],2),S(ze,{name:"notification-panel"},{default:ue(()=>[d.value?(l(),u("div",{key:0,class:"notification-panel",onClick:w[1]||(w[1]=P(()=>{},["stop"]))},[e("div",Qs,[w[2]||(w[2]=e("h3",{class:"notification-title"},"Notifications",-1)),e("div",Us,[c.value?(l(),u("button",{key:0,onClick:w[0]||(w[0]=(..._)=>M(f)&&M(f)(..._)),class:"btn-mark-all-read",title:"Tout marquer comme lu"}," ✓ Tout lire ")):k("",!0),e("button",{onClick:D,class:"btn-clear-all",title:"Effacer tout"}," 🗑️ "),e("button",{onClick:v,class:"btn-close",title:"Fermer"}," ✕ ")])]),e("div",Vs,[S(He,{name:"notification-item",tag:"div"},{default:ue(()=>[(l(!0),u(U,null,K(p.value,_=>(l(),u("div",{key:_.id,class:q(["notification-item",[`type-${_.type}`,{unread:!_.read}]]),onClick:I=>L(_)},[e("div",Ws,[e("span",Zs,C(F(_.type)),1)]),e("div",Xs,[e("h4",Js,C(_.title),1),e("p",Gs,C(_.message),1),e("time",Ys,C(x(_.timestamp)),1)]),_.read?k("",!0):(l(),u("div",ea)),e("button",{onClick:P(I=>z(_.id),["stop"]),class:"btn-remove-notification",title:"Supprimer"}," ✕ ",8,ta)],10,Ks))),128))]),_:1}),p.value.length===0?(l(),u("div",sa,w[3]||(w[3]=[e("div",{class:"empty-icon"},"🔔",-1),e("p",{class:"empty-message"},"Aucune notification",-1),e("p",{class:"empty-subtitle"},"Vous recevrez des notifications pour vos progrès !",-1)]))):k("",!0)])])):k("",!0)]),_:1}),d.value?(l(),u("div",{key:0,class:"notification-overlay",onClick:v})):k("",!0)]))}},oa=j(aa,[["__scopeId","data-v-89ab5c85"]]),na={class:"dashboard-header"},ia={class:"header-right"},ra={__name:"DashboardHeader",emits:["toggle-sidebar","subject-changed","search"],setup(n,{emit:s}){const d=s;ee();const p=o=>{d("subject-changed",o)},r=o=>{d("search",o)},c=()=>{console.log("Déconnexion effectuée depuis le header")};return(o,v)=>(l(),u("header",na,[e("button",{class:"burger-btn-fixed",onClick:v[0]||(v[0]=h=>o.$emit("toggle-sidebar")),"aria-label":"Ouvrir ou fermer le menu"},v[1]||(v[1]=[e("span",{class:"burger-icon-fixed"},"☰",-1)])),S(Bs,{"matiere-props":{matiereId:null},onSubjectChanged:p,onSearch:r}),e("div",ia,[S(oa),S(Yt,{onLogout:c})])]))}},la=j(ra,[["__scopeId","data-v-622cc6f9"]]),ca={name:"AIAssistant",props:{autoFocus:{type:Boolean,default:!1}},data(){return{currentMessage:"",selectedModel:"gpt-3.5-turbo",messages:[],isLoading:!1,error:null,conversationId:null}},watch:{currentMessage:{handler(){this.$nextTick(()=>{this.autoResizeTextarea()})}}},async mounted(){await this.loadConversationHistory(),this.autoFocus&&this.$refs.messageInput&&this.$nextTick(()=>{this.$refs.messageInput.focus()})},methods:{async sendMessage(n){if(console.log("Send button clicked",n),!this.currentMessage.trim()||this.isLoading){console.log("Cannot send: empty message or loading",{message:this.currentMessage.trim(),isLoading:this.isLoading});return}console.log("Sending message:",this.currentMessage.trim());const s={role:"user",content:this.currentMessage.trim(),timestamp:new Date};this.messages.push(s);const d=this.currentMessage.trim();this.currentMessage="",this.$nextTick(()=>{this.scrollToBottom()}),await this.sendToAI(d)},async sendSuggestion(n){this.currentMessage=n,await this.sendMessage()},async sendToAI(n){this.isLoading=!0,this.error=null;try{const s=await Me.post("/api/ai/ask/",{message:n,model:this.selectedModel},{headers:{Authorization:`Bearer ${this.getAuthToken()}`}}),d={role:"assistant",content:s.data.ai_response,timestamp:new Date,tokens:s.data.tokens_used};this.messages.push(d),this.$nextTick(()=>{this.scrollToBottom()})}catch(s){console.error("Erreur IA:",s),this.error=s.response?.data?.error||s.response?.data?.message||"Erreur lors de la requête IA";const d={role:"assistant",content:"Désolé, une erreur s'est produite. Veuillez réessayer.",timestamp:new Date,isError:!0};this.messages.push(d)}finally{this.isLoading=!1}},async loadConversationHistory(){try{const n=this.getAuthToken();if(console.log("Token d'authentification:",n?"Présent":"Absent"),!n){console.warn("Pas de token d'authentification, historique non chargé"),console.log("Vérifiez que vous êtes connecté à l'application"),console.log('Le token devrait être dans localStorage sous la clé "access_token"');return}const s=await Me.get("/api/ai/history/",{headers:{Authorization:`Bearer ${n}`}});console.log("Historique chargé:",s.data),console.log("Status HTTP:",s.status),this.messages=[],Array.isArray(s.data)?(console.log(`Chargement de ${s.data.length} conversations`),s.data.forEach((d,p)=>{console.log(`Conversation ${p}:`,d),this.messages.push({role:"user",content:d.message,timestamp:new Date(d.created_at)}),this.messages.push({role:"assistant",content:d.ai_response,timestamp:new Date(d.created_at),tokens:d.tokens_used})})):s.data&&typeof s.data=="object"?(console.warn("Structure de réponse inattendue:",s.data),s.data.results&&Array.isArray(s.data.results)&&s.data.results.forEach(d=>{this.messages.push({role:"user",content:d.message,timestamp:new Date(d.created_at)}),this.messages.push({role:"assistant",content:d.ai_response,timestamp:new Date(d.created_at),tokens:d.tokens_used})})):console.warn("Aucune donnée d'historique ou format incorrect:",s.data),console.log(`Total messages chargés: ${this.messages.length}`),this.$nextTick(()=>{this.scrollToBottom()})}catch(n){console.error("Erreur chargement historique:",n),n.response?(console.error("Erreur HTTP:",n.response.status,n.response.data),n.response.status===401?console.warn("Utilisateur non authentifié"):n.response.status===403&&console.warn("Accès interdit")):n.request?console.error("Erreur réseau:",n.request):console.error("Erreur inconnue:",n.message),this.messages=[]}},clearChat(){this.messages=[],this.conversationId=null},addNewLine(){this.currentMessage+=`
`},scrollToBottom(){this.$refs.messagesContainer&&(this.$refs.messagesContainer.scrollTop=this.$refs.messagesContainer.scrollHeight)},autoResizeTextarea(){const n=this.$refs.messageInput;n&&(n.style.height="auto",n.style.height=Math.min(n.scrollHeight,120)+"px")},formatMessage(n){return n.replace(/\n/g,"<br>")},formatTime(n){return n.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})},getAuthToken(){return localStorage.getItem("access_token")||""}}},da={class:"chatgpt-container"},ua={class:"chat-header"},ha={class:"header-info"},va={class:"header-text"},pa={class:"status"},ma={class:"header-actions"},fa={class:"messages-container",ref:"messagesContainer"},ga={key:0,class:"welcome-message"},ba={class:"welcome-content"},_a={key:0,class:"auth-warning"},ya={class:"suggestions"},ka={class:"suggestion-tags"},$a={class:"message-avatar"},wa={key:0,class:"avatar-icon user"},xa={key:1,class:"avatar-icon ai"},Ma={class:"message-content"},Ca={class:"message-bubble"},Sa={key:0,class:"message-text"},Ia=["innerHTML"],Aa={key:2,class:"message-meta"},Ea={class:"tokens-info"},za={key:0,class:"message-time"},Ta={key:1,class:"message-wrapper ai-message"},Na={class:"input-container"},La={class:"input-wrapper"},qa=["disabled"],Da=["disabled"],ja={key:0,class:"loading-spinner"},Fa={key:1},Pa={key:0,class:"error-toast"};function Ha(n,s,d,p,r,c){return l(),u("div",da,[e("div",ua,[e("div",ha,[s[10]||(s[10]=e("div",{class:"ai-avatar"},[e("span",{class:"avatar-icon"},"🤖")],-1)),e("div",va,[s[9]||(s[9]=e("h3",null,"Assistant IA OptiTAB",-1)),e("span",pa,[e("span",{class:q(["status-dot",{online:!r.isLoading}])},null,2),le(" "+C(r.isLoading?"En train d'écrire...":"En ligne"),1)])])]),e("div",ma,[e("button",{onClick:s[0]||(s[0]=(...o)=>c.clearChat&&c.clearChat(...o)),class:"clear-btn",title:"Nouvelle conversation"}," 🗑️ ")])]),e("div",fa,[r.messages.length===0?(l(),u("div",ga,[e("div",ba,[s[13]||(s[13]=e("h4",null,"👋 Bonjour ! Je suis votre assistant pédagogique IA",-1)),s[14]||(s[14]=e("p",null,"Je peux vous aider avec vos questions de mathématiques en me basant sur les exercices et cours disponibles dans OptiTAB.",-1)),c.getAuthToken()?k("",!0):(l(),u("div",_a,s[11]||(s[11]=[e("p",null,[le("⚠️ "),e("strong",null,"Connexion requise :"),le(" Connectez-vous pour utiliser l'assistant IA")],-1)]))),e("div",ya,[s[12]||(s[12]=e("p",null,"Essayez de me demander :",-1)),e("div",ka,[e("span",{onClick:s[1]||(s[1]=o=>c.sendSuggestion("Explique-moi les dérivées")),class:"tag"},"Explique-moi les dérivées"),e("span",{onClick:s[2]||(s[2]=o=>c.sendSuggestion("Donne-moi un exercice sur les intégrales")),class:"tag"},"Exercice sur les intégrales"),e("span",{onClick:s[3]||(s[3]=o=>c.sendSuggestion("Comment résoudre une équation du second degré")),class:"tag"},"Équation du second degré")])])])])):k("",!0),(l(!0),u(U,null,K(r.messages,(o,v)=>(l(),u("div",{key:v,class:q(["message-wrapper",{"user-message":o.role==="user","ai-message":o.role==="assistant"}])},[e("div",$a,[o.role==="user"?(l(),u("span",wa,"👤")):(l(),u("span",xa,"🤖"))]),e("div",Ma,[e("div",Ca,[o.role==="user"?(l(),u("div",Sa,C(o.content),1)):(l(),u("div",{key:1,class:"message-text",innerHTML:c.formatMessage(o.content)},null,8,Ia)),o.role==="assistant"&&o.tokens?(l(),u("div",Aa,[e("span",Ea,C(o.tokens)+" tokens utilisés",1)])):k("",!0)]),o.role==="assistant"?(l(),u("div",za,C(c.formatTime(o.timestamp)),1)):k("",!0)])],2))),128)),r.isLoading?(l(),u("div",Ta,s[15]||(s[15]=[Re('<div class="message-avatar" data-v-bc149a32><span class="avatar-icon ai" data-v-bc149a32>🤖</span></div><div class="message-content" data-v-bc149a32><div class="message-bubble typing" data-v-bc149a32><div class="typing-dots" data-v-bc149a32><span data-v-bc149a32></span><span data-v-bc149a32></span><span data-v-bc149a32></span></div></div></div>',2)]))):k("",!0)],512),e("div",Na,[e("div",La,[fe(e("textarea",{"onUpdate:modelValue":s[4]||(s[4]=o=>r.currentMessage=o),onKeydown:[s[5]||(s[5]=Ce(P((...o)=>n.simpleSend&&n.simpleSend(...o),["exact","prevent"]),["enter"])),s[6]||(s[6]=Ce(P((...o)=>c.addNewLine&&c.addNewLine(...o),["shift","exact"]),["enter"]))],placeholder:"Posez votre question sur les mathématiques... (Enter pour envoyer)",class:"message-input",disabled:r.isLoading,rows:"1",ref:"messageInput"},null,40,qa),[[Qe,r.currentMessage]]),e("button",{onClick:s[7]||(s[7]=(...o)=>n.simpleSend&&n.simpleSend(...o)),class:q(["send-btn",{active:r.currentMessage.trim()}]),disabled:!r.currentMessage.trim()||r.isLoading,title:"Envoyer le message"},[r.isLoading?(l(),u("span",ja,"⏳")):(l(),u("span",Fa,"📤"))],10,Da)])]),r.error?(l(),u("div",Pa,[s[16]||(s[16]=e("span",{class:"error-icon"},"⚠️",-1)),e("span",null,C(r.error),1),e("button",{onClick:s[8]||(s[8]=o=>r.error=null),class:"error-close"},"✕")])):k("",!0)])}const Ba=j(ca,[["render",Ha],["__scopeId","data-v-bc149a32"]]),Oa={name:"AIModal",components:{AIAssistant:Ba},props:{showModal:{type:Boolean,default:!1}},methods:{closeModal(){this.$emit("close")}}},Ra={class:"ai-modal-header"};function Qa(n,s,d,p,r,c){const o=Ne("AIAssistant");return d.showModal?(l(),u("div",{key:0,class:"ai-modal-overlay",onClick:s[2]||(s[2]=(...v)=>c.closeModal&&c.closeModal(...v))},[e("div",{class:"ai-modal-content",onClick:s[1]||(s[1]=P(()=>{},["stop"]))},[e("div",Ra,[s[3]||(s[3]=e("h3",null,"🤖 Assistant IA OptiTAB",-1)),e("button",{onClick:s[0]||(s[0]=(...v)=>c.closeModal&&c.closeModal(...v)),class:"close-btn"},"✕")]),S(o,{"auto-focus":!0})])])):k("",!0)}const Ua=j(Oa,[["render",Qa],["__scopeId","data-v-6287401f"]]),Va={name:"AIFloatingButton",components:{AIModal:Ua},props:{},data(){return{showModal:!1}},methods:{toggleModal(){this.showModal=!this.showModal},closeModal(){this.showModal=!1}}},Ka={class:"ai-floating-container"};function Wa(n,s,d,p,r,c){const o=Ne("AIModal");return l(),u("div",Ka,[e("button",{onClick:s[0]||(s[0]=(...v)=>c.toggleModal&&c.toggleModal(...v)),class:q(["ai-floating-btn",{active:r.showModal}]),title:"Assistant IA OptiTAB"},s[1]||(s[1]=[e("span",{class:"ai-icon"},"🤖",-1),e("span",{class:"ai-text"},"IA",-1)]),2),S(o,{"show-modal":r.showModal,onClose:c.closeModal},null,8,["show-modal","onClose"])])}const Za=j(Va,[["render",Wa],["__scopeId","data-v-b7e93243"]]),Xa={class:"dashboard-layout"},Ja={class:"dashboard-main-container"},Ga={class:"dashboard-content"},Ya={class:"dashboard-main"},eo={__name:"DashboardLayout",emits:["sidebar-toggle","navigation","subject-changed"],setup(n,{emit:s}){const d=s,p=N(null),r=ne(),c=N(!0),o=N(!1),v=()=>{o.value=!o.value,localStorage.setItem("sidebar-collapsed",o.value.toString()),console.log("[DashboardLayout] Sidebar toggled:",{collapsed:o.value})},h=b=>{d("navigation",b)},f=b=>{d("subject-changed",b)};return Z(async()=>{console.log("[DashboardLayout] onMounted - État initial:",{sidebarOpen:c.value,sidebarCollapsed:o.value});const b=localStorage.getItem("sidebar-open");b!==null&&(c.value=b==="true",console.log("[DashboardLayout] sidebarOpen restauré:",c.value));const g=localStorage.getItem("sidebar-collapsed");g!==null&&(o.value=g==="true",console.log("[DashboardLayout] sidebarCollapsed restauré:",o.value)),await he(),console.log("[DashboardLayout] onMounted - État final:",{sidebarOpen:c.value,sidebarCollapsed:o.value}),p.value}),B(()=>r.path,(b,g)=>{console.log("[DashboardLayout] Navigation détectée:",{from:g,to:b,sidebarCollapsed:o.value})},{immediate:!1}),B(()=>o.value,(b,g)=>{console.log("[DashboardLayout] sidebarCollapsed changé:",{from:g,to:b,windowWidth:window.innerWidth,windowHeight:window.innerHeight,stack:new Error().stack})},{immediate:!1}),(b,g)=>(l(),u("div",Xa,[S(la,{sidebarOpen:c.value,onToggleSidebar:v,onSubjectChanged:f},null,8,["sidebarOpen"]),e("div",Ja,[fe(S(Lt,{collapsed:o.value,onNavigation:h,onToggleCollapsed:v,ref_key:"sidebarRef",ref:p},null,8,["collapsed"]),[[Te,c.value]]),k("",!0),e("div",Ga,[e("main",Ya,[Ue(b.$slots,"default",{},void 0,!0)])])]),S(Za)]))}},oo=j(eo,[["__scopeId","data-v-11fbf57a"]]);export{oo as D,Je as r};
