import{_ as X,h as m,p as Y,c,a2 as Z,a as o,b as E,k as T,z as H,F as b,e as C,v as K,t as g,o as u,i as D,j as ee}from"./index-C20tTf3S.js";import{a as te,g as ae,l as ie}from"./curriculum-C6dJwtfd.js";import{b as se}from"./exercices-D5_EwlUY.js";import{E as re}from"./ExerciceQCM-DJualaHI.js";const ne={class:"bulk-form"},oe=["value"],le={class:"images-upload-section"},ce={key:0,class:"selected-images"},ue=["src","alt"],de={class:"image-name"},me=["onClick"],pe={class:"btn-group"},ge=["disabled"],ve=["disabled"],fe={key:0,class:"success-msg"},he={key:1,class:"error-msg"},ye={key:2,class:"info-msg"},Ie={key:3,class:"preview-section"},_e={key:0,class:"preview-image-info"},Ee={class:"image-indicator"},we={class:"image-status-list"},Me=10*1024*1024,be={__name:"AdminExercicesPlus",setup(Ce){const S=["image/jpeg","image/jpg","image/png","image/gif","image/webp"],N=m([]),$=m([]),v=m(""),y=m(""),w=m(""),f=m(""),I=m([]),k=m(!1),_=m([]),M=m(null);class q{constructor(){this.images=new Map,this.imageTypes=new Map}addImage(e){if(!this.validateImage(e))throw new Error(`Image invalide: ${e.name}`);this.images.set(e.name,e)}removeImage(e){this.images.delete(e),this.imageTypes.delete(e)}validateImage(e){return!(!S.includes(e.type)||e.size>Me)}getImage(e){let t=this.images.get(e);if(t)return t;for(const[i,a]of this.images)if(i.toLowerCase()===e.toLowerCase())return a;for(const[i,a]of this.images)if(i.toLowerCase().includes(e.toLowerCase())||e.toLowerCase().includes(i.toLowerCase()))return a;return null}determineImageType(e,t){const i=`[IMAGE_${t}]`;return e.solution&&e.solution.includes(i)||e.etapes&&e.etapes.includes(i)?"solution":"donnee"}createPreviewImages(e,t=null){return e?this.parseImageString(e).map((a,r)=>{const l=this.getImage(a),d=t?this.determineImageType(t,r+1):"donnee";return{id:`preview-${r}`,image:l?URL.createObjectURL(l):a,image_type:d,position:r+1}}):[]}parseImageString(e){return e.split(",").map(t=>t.trim()).filter(Boolean)}validateImageReferences(e){if(!e)return{valid:!0,missing:[]};const t=this.parseImageString(e),i=t.filter(a=>!this.getImage(a));return{valid:i.length===0,missing:i,available:t.filter(a=>this.getImage(a))}}cleanup(){this.images.clear(),this.imageTypes.clear()}}class P{constructor(e){this.imageManager=e}parseExercices(e){return e.includes("===")?this.parseBlockFormat(e):this.parseLineFormat(e)}parseBlockFormat(e){const t=e.split(/^===/m).map(i=>i.trim()).filter(i=>i&&!i.match(/^===$/));return console.log("üîç Blocs d√©tect√©s:",t.length),t.map((i,a)=>this.parseBlock(i,a))}parseBlock(e,t){const i=e.split(`
`),a={titre:"",instruction:"",etapes:"",solution:"",image:"",difficulty:"medium",chapitre:Number(v.value)};let r=null,l=!0;for(const d of i){const n=d.trim();if(n){if(l){const h=n.match(/^\[(.*)\]$/);h?a.titre=h[1].trim():a.titre=n,l=!1;continue}if(n.match(/^√ânonc√©:/i))r="instruction",a.instruction=n.replace(/^√ânonc√©:/i,"").trim();else if(n.match(/^√âtapes?:/i))r="etapes",a.etapes=n.replace(/^√âtapes?:/i,"").trim();else if(n.startsWith("Solution:"))r="solution",a.solution=n.slice(9).trim();else if(n.startsWith("Image:"))a.image=n.slice(6).trim();else if(n.match(/^Difficult[e√©]:/i)){const h=n.match(/^Difficult[e√©]:\s*(.+)/i);h&&(a.difficulty=h[1].trim().toLowerCase())}else r&&(a[r]+=`
`+n);l=!1}}return a}parseLineFormat(e){return e.split(`
`).map(i=>i.trim()).filter(Boolean).map(i=>{const a=i.split(";;").map(r=>r.trim());return{titre:a[0]||"",instruction:a[1]||"",etapes:a[2]||"",solution:a[3]||"",difficulty:(a[4]||"medium").toLowerCase(),chapitre:Number(v.value),image:a[5]||""}})}}class B{constructor(e){this.imageManager=e}async createExerciceWithImages(e){try{const t=(e.difficulty||"medium").toLowerCase(),i=e.titre&&e.titre.trim()?e.titre.trim():"Exercice",a=e.instruction&&e.instruction.trim()?e.instruction.trim():i,r=e.solution&&e.solution.trim()?e.solution.trim():"A compl√©ter",l={chapitre:Number(e.chapitre||v.value),titre:i,contenu:a,difficulty:["easy","medium","hard"].includes(t)?t:"medium",question:a,reponse_correcte:r,etapes:e.etapes||"",points:1},n=(await ie(l))?.id;return e.image&&await this.addImagesToExercice(n,e),{success:!0,exerciceId:n}}catch(t){return console.error("Erreur lors de la cr√©ation de l'exercice:",t,t?.response?.data),{success:!1,error:t.response?.data?JSON.stringify(t.response.data):t.message||"Erreur inconnue"}}}async addImagesToExercice(e,t){const i=this.imageManager.parseImageString(t.image),a=[];for(let r=0;r<i.length;r++){const l=i[r],d=this.imageManager.getImage(l);if(d)try{const n=this.imageManager.determineImageType(t,r+1);await se({exercice:e,image:d,image_type:n,position:r+1})}catch(n){console.error(`Erreur lors de l'ajout de l'image ${l}:`,n),a.push(`Image ${l} non ajout√©e`)}else a.push(`Image ${l} non trouv√©e`)}return a}}const p=new q,j=new P(p),z=new B(p);async function R(){try{const[s,e]=await Promise.all([te(),ae()]);N.value=Array.isArray(s)?s:s?.data||[],$.value=Array.isArray(e)?e:e?.data||[]}catch(s){console.error("Erreur lors du chargement:",s)}}function L(s){return $.value.find(e=>String(e.id)===String(s))}function F(s){if(!s)return null;const e=L(s.notion);if(!e)return{themeNom:"",matiereNom:"",paysNom:"",niveauNom:""};const t=e.matiere_nom||e.contexte_detail&&e.contexte_detail.matiere_nom||"",i=e.theme_nom||"",a=e.contexte_detail&&e.contexte_detail.pays?e.contexte_detail.pays.nom:"",r=e.contexte_detail&&e.contexte_detail.niveau?e.contexte_detail.niveau.nom:"";return{matiereNom:t,themeNom:i,paysNom:a,niveauNom:r}}function U(s){const e=L(s.notion),t=F(s);return[s.nom,e?`‚Äî ${e.nom}`:"",t&&t.matiereNom?`‚Äî ${t.matiereNom}`:"",t&&(t.paysNom||t.niveauNom)?`‚Äî ${[t.paysNom,t.niveauNom].filter(Boolean).join(" ¬∑ ")}`:""].filter(Boolean).join(" ")}function V(s){Array.from(s.target.files).forEach(t=>{try{p.addImage(t)}catch(i){f.value=i.message}}),_.value=Array.from(p.images.values())}function G(s){const e=_.value[s];p.removeImage(e.name),_.value.splice(s,1),M.value&&(M.value.value="")}function O(s){return URL.createObjectURL(s)}function x(s){return p.getImage(s)}function W(s,e=null){return p.createPreviewImages(s,e)}function A(){return j.parseExercices(y.value)}async function Q(){if(f.value="",w.value="",!v.value){f.value="‚ö†Ô∏è Veuillez s√©lectionner un chapitre dans la liste d√©roulante.";return}try{const s=A();console.log("üîÑ Donn√©es √† envoyer:",s);let e=0,t=[];const i=new Set;for(const a of s){a.chapitre=Number(v.value);let r=a.titre&&a.titre.trim()?a.titre.trim():"Exercice",l=r,d=1;for(;i.has(l.toLowerCase());)d+=1,l=`${r} (${d})`;a.titre=l,i.add(l.toLowerCase());const n=p.validateImageReferences(a.image);if(!n.valid){t.push(`Images manquantes pour "${a.titre}": ${n.missing.join(", ")}`);continue}const h=await z.createExerciceWithImages(a);h.success?e++:t.push(`Erreur pour "${a.titre}": ${h.error}`)}e>0&&(w.value=`‚úÖ ${e} exercice(s) cr√©√©(s) avec succ√®s !`,t.length>0&&(w.value+=` (${t.length} erreur(s) mineure(s))`),y.value="",p.cleanup(),_.value=[],M.value&&(M.value.value=""),I.value=[]),t.length>0&&(f.value=`‚ö†Ô∏è Erreurs rencontr√©es :
`+t.join(`
`))}catch(s){console.error("Erreur g√©n√©rale:",s),f.value=`‚ùå Erreur lors de la cr√©ation : ${s.response?.data?.message||s.message}`}}function J(){try{I.value=A(),k.value=I.value.length>0}catch(s){console.error("Erreur lors de la pr√©visualisation:",s),f.value=`‚ùå Erreur de format : ${s.message}`}}return Y(R),(s,e)=>(u(),c("div",null,[e[6]||(e[6]=Z(`<h2 class="admin-title" data-v-a2d64e4c>Bulk ‚Äì Ajout d&#39;Exercices</h2><div class="format-help" data-v-a2d64e4c><h3 data-v-a2d64e4c>üìã Format requis :</h3><div class="format-example" data-v-a2d64e4c><pre data-v-a2d64e4c><code data-v-a2d64e4c>=== [Titre de l&#39;exercice]
Difficult√©: [easy/medium/hard]
Image: [nom_fichier1.jpg,nom_fichier2.png] (optionnel)

√ânonc√©: [description de l&#39;exercice]

[IMAGE_1]

[suite de l&#39;√©nonc√©]

[IMAGE_2]

[fin de l&#39;√©nonc√©]

√âtapes: [√©tapes de r√©solution d√©taill√©es]

**Question 1 : [Titre de la premi√®re question]**
    ‚óè [Premi√®re √©tape]
    ‚óè [Deuxi√®me √©tape]
    ‚óè [Troisi√®me √©tape]

**Question 2 : [Titre de la deuxi√®me question]**
    ‚óè [Premi√®re √©tape]
    ‚óè [Deuxi√®me √©tape]

Solution:
1. [R√©ponse √† la question 1]
2. [R√©ponse √† la question 2]

===
</code></pre></div><div class="format-notes" data-v-a2d64e4c><p data-v-a2d64e4c><strong data-v-a2d64e4c>Notes importantes :</strong></p><ul data-v-a2d64e4c><li data-v-a2d64e4c>Utilisez <code data-v-a2d64e4c>===</code> pour d√©limiter chaque exercice</li><li data-v-a2d64e4c><strong data-v-a2d64e4c>‚ö†Ô∏è IMPORTANT :</strong> S√©lectionnez d&#39;abord le chapitre dans la liste d√©roulante ci-dessus</li><li data-v-a2d64e4c>Difficult√© : <code data-v-a2d64e4c>easy</code>, <code data-v-a2d64e4c>medium</code> ou <code data-v-a2d64e4c>hard</code> uniquement</li><li data-v-a2d64e4c>Images multiples : S√©parez les noms de fichiers par des virgules : <code data-v-a2d64e4c>image1.jpg,image2.png</code></li><li data-v-a2d64e4c>Positionnement d&#39;images : Utilisez <code data-v-a2d64e4c>[IMAGE_1]</code>, <code data-v-a2d64e4c>[IMAGE_2]</code>, etc. dans l&#39;√©nonc√© pour positionner les images</li><li data-v-a2d64e4c>Ordre des images : Les images sont assign√©es dans l&#39;ordre de leur d√©claration (1√®re = [IMAGE_1], 2√®me = [IMAGE_2], etc.)</li><li data-v-a2d64e4c>Types d&#39;images automatiques : Les images dans l&#39;√©nonc√© = &quot;Donn√©e&quot;, dans les √©tapes/solution = &quot;Solution&quot;</li><li data-v-a2d64e4c>√âtapes : D√©crivez les √©tapes de r√©solution pour guider l&#39;√©l√®ve</li><li data-v-a2d64e4c>MathJax support√© : <code data-v-a2d64e4c>$formule$</code> (inline) et <code data-v-a2d64e4c>$$formule$$</code> (bloc)</li><li data-v-a2d64e4c>Markdown support√© : <code data-v-a2d64e4c>**gras**</code> et <code data-v-a2d64e4c>*italique*</code></li><li data-v-a2d64e4c>Laissez <code data-v-a2d64e4c>Image:</code> vide si pas d&#39;image</li></ul></div></div>`,2)),o("div",ne,[T(o("select",{"onUpdate:modelValue":e[0]||(e[0]=t=>v.value=t),required:""},[e[2]||(e[2]=o("option",{disabled:"",value:""},"Choisir chapitre",-1)),(u(!0),c(b,null,C(N.value,t=>(u(),c("option",{key:t.id,value:t.id},g(U(t)),9,oe))),128))],512),[[H,v.value]]),o("div",le,[e[4]||(e[4]=o("h4",null,"üìÅ Images pour les exercices",-1)),e[5]||(e[5]=o("p",{class:"upload-help"},"Uploadez les images qui seront r√©f√©renc√©es dans vos exercices :",-1)),o("input",{type:"file",ref_key:"imagesInput",ref:M,onChange:V,accept:"image/*",multiple:"",class:"images-file-input"},null,544),_.value.length>0?(u(),c("div",ce,[e[3]||(e[3]=o("h5",null,"Images s√©lectionn√©es :",-1)),(u(!0),c(b,null,C(_.value,(t,i)=>(u(),c("div",{key:i,class:"selected-image-item"},[o("img",{src:O(t),alt:t.name,class:"image-preview"},null,8,ue),o("span",de,g(t.name),1),o("button",{type:"button",class:"btn-remove",onClick:a=>G(i)},"√ó",8,me)]))),128))])):E("",!0)]),T(o("textarea",{"onUpdate:modelValue":e[1]||(e[1]=t=>y.value=t),placeholder:"Coller ici vos exercices‚Ä¶"},null,512),[[K,y.value]]),o("div",pe,[o("button",{class:"btn-secondary",onClick:J,disabled:!y.value.trim(),type:"button"},"Pr√©visualiser",8,ge),o("button",{class:"btn-primary",onClick:Q,disabled:!v.value||!y.value.trim()},"Cr√©er les exercices",8,ve)])]),w.value?(u(),c("div",fe,g(w.value),1)):E("",!0),f.value?(u(),c("div",he,g(f.value),1)):E("",!0),I.value.length===0&&y.value.trim()&&k.value?(u(),c("div",ye,"Aucun exercice valide trouv√©. V√©rifiez le format.")):E("",!0),I.value.length?(u(),c("div",Ie,[o("h3",null,"Aper√ßu ("+g(I.value.length)+")",1),(u(!0),c(b,null,C(I.value,(t,i)=>(u(),c("div",{key:i,class:"preview-item"},[o("h4",null,g(t.titre),1),t.image?(u(),c("div",_e,[o("span",Ee,"üñºÔ∏è Images: "+g(t.image),1),o("div",we,[(u(!0),c(b,null,C(t.image.split(",").map(a=>a.trim()).filter(Boolean),a=>(u(),c("span",{key:a,class:ee(["image-status",x(a)?"available":"missing"])},g(a)+": "+g(x(a)?"‚úÖ Disponible":"‚ùå Manquante"),3))),128))])])):E("",!0),D(re,{eid:`preview-${i}`,titre:t.titre,instruction:t.instruction,etapes:t.etapes,solution:t.solution,difficulty:t.difficulty,"preview-images":W(t.image,t)},null,8,["eid","titre","instruction","etapes","solution","difficulty","preview-images"])]))),128))])):E("",!0)]))}},xe=X(be,[["__scopeId","data-v-a2d64e4c"]]);export{xe as default};
