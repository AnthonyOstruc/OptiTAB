import{a as d,c as Z,e as H,b as c,a1 as D,d as o,i as w,m as k,K as P,M as ee,F as M,s as N,t as v,o as u,j as te,n as ae}from"./vendor-1gmgAmFu.js";import{_ as ie}from"./index-DCsGFNRY.js";import{a as se,f as re,l as ne}from"./curriculum-snq3CWRS.js";import{b as oe}from"./exercices-DZNA1MYX.js";import{E as le}from"./ExerciceQCM--pNzSXAP.js";import"./ui-jaH5oyHW.js";import"./pdf-B39ievqC.js";import"./mathlive-B5k0jhbN.js";const ce={class:"bulk-form"},ue=["value"],de={class:"images-upload-section"},me={key:0,class:"selected-images"},pe=["src","alt"],ge={class:"image-name"},ve=["onClick"],fe={class:"btn-group"},he=["disabled"],ye=["disabled"],Ie={key:0,class:"success-msg"},_e={key:1,class:"error-msg"},we={key:2,class:"info-msg"},Ee={key:3,class:"preview-section"},Ce={key:0,class:"preview-image-info"},be={class:"image-indicator"},Me={class:"image-status-list"},Ne=10*1024*1024,$e={__name:"AdminExercicesPlus",setup(ke){const B=["image/jpeg","image/jpg","image/png","image/gif","image/webp"],$=d([]),L=d([]),b=d(""),m=d(""),y=d(""),E=d(""),f=d(""),I=d([]),x=d(!1),_=d([]),C=d(null);class j{constructor(){this.images=new Map,this.imageTypes=new Map}addImage(e){if(!this.validateImage(e))throw new Error(`Image invalide: ${e.name}`);this.images.set(e.name,e)}removeImage(e){this.images.delete(e),this.imageTypes.delete(e)}validateImage(e){return!(!B.includes(e.type)||e.size>Ne)}getImage(e){let t=this.images.get(e);if(t)return t;for(const[i,a]of this.images)if(i.toLowerCase()===e.toLowerCase())return a;for(const[i,a]of this.images)if(i.toLowerCase().includes(e.toLowerCase())||e.toLowerCase().includes(i.toLowerCase()))return a;return null}determineImageType(e,t){const i=`[IMAGE_${t}]`;return e.solution&&e.solution.includes(i)||e.etapes&&e.etapes.includes(i)?"solution":"donnee"}createPreviewImages(e,t=null){return e?this.parseImageString(e).map((a,r)=>{const l=this.getImage(a),p=t?this.determineImageType(t,r+1):"donnee";return{id:`preview-${r}`,image:l?URL.createObjectURL(l):a,image_type:p,position:r+1}}):[]}parseImageString(e){return e.split(",").map(t=>t.trim()).filter(Boolean)}validateImageReferences(e){if(!e)return{valid:!0,missing:[]};const t=this.parseImageString(e),i=t.filter(a=>!this.getImage(a));return{valid:i.length===0,missing:i,available:t.filter(a=>this.getImage(a))}}cleanup(){this.images.clear(),this.imageTypes.clear()}}class F{constructor(e){this.imageManager=e}parseExercices(e){return e.includes("===")?this.parseBlockFormat(e):this.parseLineFormat(e)}parseBlockFormat(e){return e.split(/^===/m).map(i=>i.trim()).filter(i=>i&&!i.match(/^===$/)).map((i,a)=>this.parseBlock(i,a))}parseBlock(e,t){const i=e.split(`
`),a={titre:"",instruction:"",etapes:"",solution:"",image:"",difficulty:"medium",chapitre:Number(m.value)};let r=null,l=!0;for(const p of i){const n=p.trim();if(n){if(l){const h=n.match(/^\[(.*)\]$/);h?a.titre=h[1].trim():a.titre=n,l=!1;continue}if(n.match(/^√ânonc√©:/i))r="instruction",a.instruction=n.replace(/^√ânonc√©:/i,"").trim();else if(n.match(/^√âtapes?:/i))r="etapes",a.etapes=n.replace(/^√âtapes?:/i,"").trim();else if(n.startsWith("Solution:"))r="solution",a.solution=n.slice(9).trim();else if(n.startsWith("Image:"))a.image=n.slice(6).trim();else if(n.match(/^Difficult[e√©]:/i)){const h=n.match(/^Difficult[e√©]:\s*(.+)/i);h&&(a.difficulty=h[1].trim().toLowerCase())}else r&&(a[r]+=`
`+n);l=!1}}return a}parseLineFormat(e){return e.split(`
`).map(i=>i.trim()).filter(Boolean).map(i=>{const a=i.split(";;").map(r=>r.trim());return{titre:a[0]||"",instruction:a[1]||"",etapes:a[2]||"",solution:a[3]||"",difficulty:(a[4]||"medium").toLowerCase(),chapitre:Number(m.value),image:a[5]||""}})}}class R{constructor(e){this.imageManager=e}async createExerciceWithImages(e){try{const t=(e.difficulty||"medium").toLowerCase(),i=e.titre&&e.titre.trim()?e.titre.trim():"Exercice",a=e.instruction&&e.instruction.trim()?e.instruction.trim():i,r=e.solution&&e.solution.trim()?e.solution.trim():"A compl√©ter",l={chapitre:Number(e.chapitre||m.value),titre:i,contenu:a,difficulty:["easy","medium","hard"].includes(t)?t:"medium",question:a,reponse_correcte:r,etapes:e.etapes||"",points:1},n=(await ne(l))?.id;return e.image&&await this.addImagesToExercice(n,e),{success:!0,exerciceId:n}}catch(t){return{success:!1,error:t.response?.data?JSON.stringify(t.response.data):t.message||"Erreur inconnue"}}}async addImagesToExercice(e,t){const i=this.imageManager.parseImageString(t.image),a=[];for(let r=0;r<i.length;r++){const l=i[r],p=this.imageManager.getImage(l);if(p)try{const n=this.imageManager.determineImageType(t,r+1);await oe({exercice:e,image:p,image_type:n,position:r+1})}catch{a.push(`Image ${l} non ajout√©e`)}else a.push(`Image ${l} non trouv√©e`)}return a}}const g=new j,z=new F(g),U=new R(g);async function V(){try{const[s,e]=await Promise.all([se(),re()]);$.value=Array.isArray(s)?s:s?.data||[],L.value=Array.isArray(e)?e:e?.data||[]}catch{}}function A(s){return L.value.find(e=>String(e.id)===String(s))}function G(s){if(!s)return null;const e=A(s.notion);if(!e)return{themeNom:"",matiereNom:"",paysNom:"",niveauNom:""};const t=e.matiere_nom||e.contexte_detail&&e.contexte_detail.matiere_nom||"",i=e.theme_nom||"",a=e.contexte_detail&&e.contexte_detail.pays?e.contexte_detail.pays.nom:"",r=e.contexte_detail&&e.contexte_detail.niveau?e.contexte_detail.niveau.nom:"";return{matiereNom:t,themeNom:i,paysNom:a,niveauNom:r}}function T(s){const e=A(s.notion),t=G(s);return[s.nom,e?`‚Äî ${e.nom}`:"",t&&t.matiereNom?`‚Äî ${t.matiereNom}`:"",t&&(t.paysNom||t.niveauNom)?`‚Äî ${[t.paysNom,t.niveauNom].filter(Boolean).join(" ¬∑ ")}`:""].filter(Boolean).join(" ")}function O(s){Array.from(s.target.files).forEach(t=>{try{g.addImage(t)}catch(i){f.value=i.message}}),_.value=Array.from(g.images.values())}function W(s){const e=_.value[s];g.removeImage(e.name),_.value.splice(s,1),C.value&&(C.value.value="")}function Q(s){return URL.createObjectURL(s)}function S(s){return g.getImage(s)}function J(s,e=null){return g.createPreviewImages(s,e)}function q(){return z.parseExercices(y.value)}async function K(){if(f.value="",E.value="",!m.value){f.value="‚ö†Ô∏è Veuillez s√©lectionner un chapitre dans la liste d√©roulante.";return}try{const s=q();let e=0,t=[];const i=new Set;for(const a of s){a.chapitre=Number(m.value);let r=a.titre&&a.titre.trim()?a.titre.trim():"Exercice",l=r,p=1;for(;i.has(l.toLowerCase());)p+=1,l=`${r} (${p})`;a.titre=l,i.add(l.toLowerCase());const n=g.validateImageReferences(a.image);if(!n.valid){t.push(`Images manquantes pour "${a.titre}": ${n.missing.join(", ")}`);continue}const h=await U.createExerciceWithImages(a);h.success?e++:t.push(`Erreur pour "${a.titre}": ${h.error}`)}if(e>0){E.value=`‚úÖ ${e} exercice(s) cr√©√©(s) avec succ√®s !`,t.length>0&&(E.value+=` (${t.length} erreur(s) mineure(s))`);const a=m.value;y.value="",g.cleanup(),_.value=[],C.value&&(C.value.value=""),I.value=[],m.value=a}t.length>0&&(f.value=`‚ö†Ô∏è Erreurs rencontr√©es :
`+t.join(`
`))}catch(s){f.value=`‚ùå Erreur lors de la cr√©ation : ${s.response?.data?.message||s.message}`}}function X(){try{I.value=q(),x.value=I.value.length>0}catch(s){f.value=`‚ùå Erreur de format : ${s.message}`}}const Y=Z(()=>{if(!b.value)return $.value;const s=b.value.toLowerCase();return $.value.filter(e=>T(e).toLowerCase().includes(s))});return H(V),(s,e)=>(u(),c("div",null,[e[7]||(e[7]=D(`<h2 class="admin-title" data-v-7dd3a4aa>Bulk ‚Äì Ajout d&#39;Exercices</h2><div class="format-help" data-v-7dd3a4aa><h3 data-v-7dd3a4aa>üìã Format requis :</h3><div class="format-example" data-v-7dd3a4aa><pre data-v-7dd3a4aa><code data-v-7dd3a4aa>=== [Titre de l&#39;exercice]
Difficult√©: [easy/medium/hard]
Image: [nom_fichier1.jpg,nom_fichier2.png] (optionnel)

√ânonc√©: [description de l&#39;exercice]

[IMAGE_1]

[suite de l&#39;√©nonc√©]

[IMAGE_2]

[fin de l&#39;√©nonc√©]

√âtapes: [√©tapes de r√©solution d√©taill√©es]

**Question 1 : [Titre de la premi√®re question]**
    ‚óè [Premi√®re √©tape]
    ‚óè [Deuxi√®me √©tape]
    ‚óè [Troisi√®me √©tape]

**Question 2 : [Titre de la deuxi√®me question]**
    ‚óè [Premi√®re √©tape]
    ‚óè [Deuxi√®me √©tape]

Solution:
1. [R√©ponse √† la question 1]
2. [R√©ponse √† la question 2]

===
</code></pre></div><div class="format-notes" data-v-7dd3a4aa><p data-v-7dd3a4aa><strong data-v-7dd3a4aa>Notes importantes :</strong></p><ul data-v-7dd3a4aa><li data-v-7dd3a4aa>Utilisez <code data-v-7dd3a4aa>===</code> pour d√©limiter chaque exercice</li><li data-v-7dd3a4aa><strong data-v-7dd3a4aa>‚ö†Ô∏è IMPORTANT :</strong> S√©lectionnez d&#39;abord le chapitre dans la liste d√©roulante ci-dessus</li><li data-v-7dd3a4aa>Difficult√© : <code data-v-7dd3a4aa>easy</code>, <code data-v-7dd3a4aa>medium</code> ou <code data-v-7dd3a4aa>hard</code> uniquement</li><li data-v-7dd3a4aa>Images multiples : S√©parez les noms de fichiers par des virgules : <code data-v-7dd3a4aa>image1.jpg,image2.png</code></li><li data-v-7dd3a4aa>Positionnement d&#39;images : Utilisez <code data-v-7dd3a4aa>[IMAGE_1]</code>, <code data-v-7dd3a4aa>[IMAGE_2]</code>, etc. dans l&#39;√©nonc√© pour positionner les images</li><li data-v-7dd3a4aa>Ordre des images : Les images sont assign√©es dans l&#39;ordre de leur d√©claration (1√®re = [IMAGE_1], 2√®me = [IMAGE_2], etc.)</li><li data-v-7dd3a4aa>Types d&#39;images automatiques : Les images dans l&#39;√©nonc√© = &quot;Donn√©e&quot;, dans les √©tapes/solution = &quot;Solution&quot;</li><li data-v-7dd3a4aa>√âtapes : D√©crivez les √©tapes de r√©solution pour guider l&#39;√©l√®ve</li><li data-v-7dd3a4aa>MathJax support√© : <code data-v-7dd3a4aa>$formule$</code> (inline) et <code data-v-7dd3a4aa>$$formule$$</code> (bloc)</li><li data-v-7dd3a4aa>Markdown support√© : <code data-v-7dd3a4aa>**gras**</code> et <code data-v-7dd3a4aa>*italique*</code></li><li data-v-7dd3a4aa>Laissez <code data-v-7dd3a4aa>Image:</code> vide si pas d&#39;image</li></ul></div></div>`,2)),o("div",ce,[k(o("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>b.value=t),type:"text",placeholder:"Filtrer les chapitres...",class:"filter-input"},null,512),[[P,b.value]]),k(o("select",{"onUpdate:modelValue":e[1]||(e[1]=t=>m.value=t),required:""},[e[3]||(e[3]=o("option",{disabled:"",value:""},"Choisir chapitre",-1)),(u(!0),c(M,null,N(Y.value,t=>(u(),c("option",{key:t.id,value:t.id},v(T(t)),9,ue))),128))],512),[[ee,m.value]]),o("div",de,[e[5]||(e[5]=o("h4",null,"üìÅ Images pour les exercices",-1)),e[6]||(e[6]=o("p",{class:"upload-help"},"Uploadez les images qui seront r√©f√©renc√©es dans vos exercices :",-1)),o("input",{type:"file",ref_key:"imagesInput",ref:C,onChange:O,accept:"image/*",multiple:"",class:"images-file-input"},null,544),_.value.length>0?(u(),c("div",me,[e[4]||(e[4]=o("h5",null,"Images s√©lectionn√©es :",-1)),(u(!0),c(M,null,N(_.value,(t,i)=>(u(),c("div",{key:i,class:"selected-image-item"},[o("img",{src:Q(t),alt:t.name,class:"image-preview"},null,8,pe),o("span",ge,v(t.name),1),o("button",{type:"button",class:"btn-remove",onClick:a=>W(i)},"√ó",8,ve)]))),128))])):w("",!0)]),k(o("textarea",{"onUpdate:modelValue":e[2]||(e[2]=t=>y.value=t),placeholder:"Coller ici vos exercices‚Ä¶"},null,512),[[P,y.value]]),o("div",fe,[o("button",{class:"btn-secondary",onClick:X,disabled:!y.value.trim(),type:"button"},"Pr√©visualiser",8,he),o("button",{class:"btn-primary",onClick:K,disabled:!m.value||!y.value.trim()},"Cr√©er les exercices",8,ye)])]),E.value?(u(),c("div",Ie,v(E.value),1)):w("",!0),f.value?(u(),c("div",_e,v(f.value),1)):w("",!0),I.value.length===0&&y.value.trim()&&x.value?(u(),c("div",we,"Aucun exercice valide trouv√©. V√©rifiez le format.")):w("",!0),I.value.length?(u(),c("div",Ee,[o("h3",null,"Aper√ßu ("+v(I.value.length)+")",1),(u(!0),c(M,null,N(I.value,(t,i)=>(u(),c("div",{key:i,class:"preview-item"},[o("h4",null,v(t.titre),1),t.image?(u(),c("div",Ce,[o("span",be,"üñºÔ∏è Images: "+v(t.image),1),o("div",Me,[(u(!0),c(M,null,N(t.image.split(",").map(a=>a.trim()).filter(Boolean),a=>(u(),c("span",{key:a,class:ae(["image-status",S(a)?"available":"missing"])},v(a)+": "+v(S(a)?"‚úÖ Disponible":"‚ùå Manquante"),3))),128))])])):w("",!0),te(le,{eid:`preview-${i}`,titre:t.titre,instruction:t.instruction,etapes:t.etapes,solution:t.solution,difficulty:t.difficulty,"preview-images":J(t.image,t)},null,8,["eid","titre","instruction","etapes","solution","difficulty","preview-images"])]))),128))])):w("",!0)]))}},je=ie($e,[["__scopeId","data-v-7dd3a4aa"]]);export{je as default};
